# Project Context

## Purpose
Novel-Engine (StoryForge) is a production-oriented AI-driven narrative generation and multi-agent simulation platform. It supports collaborative storytelling between humans and AI agents, focusing on consistency, observability, and reproducible narrative logic.

## Tech Stack
- **Backend:** Python 3.11+, FastAPI, Uvicorn.
- **Frontend:** React 18, Vite, TypeScript, Shadcn UI, Zustand, TanStack Query, React Flow.
- **AI/ML:** Multi-agent architecture (DirectorAgent, PersonaAgent, ChroniclerAgent) with LLM integration.
- **Testing:**
  - Backend: pytest (with coverage).
  - Frontend: Vitest (unit), Playwright (E2E/UAT).
- **Infrastructure:** Docker, Nginx, GitHub Actions (simulated locally with `act`).

## Project Conventions

### Code Style
- **Python:** Black, Isort, Flake8, Mypy. Follow PEP 8. Use type hints extensively.
- **TypeScript/React:** ESLint, Prettier. Use functional components and hooks.
- **Naming:** CamelCase for classes/types, snake_case for Python variables/functions, camelCase for JavaScript variables/functions.

### Architecture Patterns
- **Functional Core, Imperative Shell:** Pure logic in the core, side effects (I/O) at the boundaries.
- **Multi-Agent Orchestration:** Specialized agents collaborating via an event bus or direct coordination.
- **Flow-Based UI:** Dashboard layout using a "stream-feed" and "control-cluster" pattern.
- **Guest-First Persistence:** Systems are designed to be usable by guests immediately, with filesystem-backed workspaces.

### Testing Strategy
- **TDD Mandatory:** Write tests before or alongside implementation.
- **CI Parity:** Every change must pass the local validation scripts (`scripts/validate_ci_locally.sh` for backend, `npm run lint:all` + `npm test` for frontend).
- **E2E Coverage:** UI changes require Playwright suites (Core, Extended, Interactions, Accessibility).

### Git Workflow
- Atomic commits with clear descriptions.
- Update `PROJECT_DOCS.md` and `openspec/` in the same commit as code changes.
- Use `openspec` for tracking major changes and features.

## Domain Context
- **"Death of the Author":** Theoretical foundation where narrative meaning is generated by the system and reader interaction, not just a single authorial intent.
- **Orchestration:** The process of coordinating agents to maintain narrative consistency and world state.
- **Workspaces:** Isolated filesystem environments for guest or user sessions, containing characters, campaigns, and session logs.

## Important Constraints
- **No Database Dependency:** Core persistence is filesystem-backed for simplicity and portability.
- **Performance:** Maintain low latency for AI interactions and high density for the dashboard layout.
- **Accessibility:** UI must meet basic a11y standards (tested via Playwright/axe).

## External Dependencies
- **LLM APIs:** OpenAI/Anthropic or local providers.
- **Redis/GeoIP:** Optional/Mockable services for advanced features.

## API Conventions
- **Canonical Prefix:** All product APIs MUST use the `/api` prefix.
- **No Path Versioning:** Avoid `/api/v1` or `/api/v2` in the URL path. Versioning should be handled via headers or evolutionary schema changes if needed.
- **Link to Decision:** See `openspec/changes/archive/2025-12-22-standardize-api-surface` for the standardization rationale.

## Persistence Conventions
- **Location:**
  - `characters/`: User-owned character profiles (Markdown/YAML).
  - `campaigns/`: Campaign metadata and shared data.
  - `codex/`: Generated session data and narrative history.
  - `data/`: General persistence and backups.
- **Guest Workspaces:** Data is scoped to session-specific filesystem workspaces.

## AI-Friendly Development
- **Stable Boundaries:** 
  - New endpoints go in `src/api/routers/`.
  - Business logic goes in `src/services/` or `src/core/`.
- **UI Hooks:** Use `data-role` for semantic zones and `data-testid` for interactive elements to ensure reliable automation and MCP interaction.
- **Predictability:** Favor pure functions and immutable data structures to make logic easier for AI to reason about.
