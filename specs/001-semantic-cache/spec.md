# Feature Specification: Semantic Cache

**Feature Branch**: `001-semantic-cache`  
**Created**: 2025-10-31  
**Status**: Draft  
**Input**: User description: "实现上述对话讨论的基于语义分析的缓存机制"

## Clarifications

### Session 2025-10-31

- Q: 语义缓存应采用何种阈值与守卫校验策略？ → A: High=0.92, Low=0.85, Keyword≥0.40, Length Δ≤15%

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 快速命中与稳定复用（入口缓存优先） (Priority: P1)
当用户多次发起语义相近的请求（措辞不同但意图一致）时，系统在不调用模型的前提下返回已验证过的结果，显著降低等待时间与费用。

**Why this priority**: 直接影响核心体验的响应时间与运行成本，是最显著的价值点。

**Independent Test**: 构造一组改写相近的请求，验证在阈值策略下命中率≥设定目标且结果一致性通过抽检。

**Acceptance Scenarios**:
1. Given 用户以“相同模板版本/索引版本/模型配置”发起语义相近的请求，When 入口缓存检查，Then 在不调用提供方的情况下返回缓存结果，附注命中类型与相似度。
2. Given 用户以措辞略有变化发起请求，When 相似度≥高阈值，Then 直接命中；When 介于低/高阈值之间且守卫检查通过，Then 命中；否则回退到提供方。

---

### User Story 2 - 事件驱动的精确失效（保证新鲜度） (Priority: P1)
当模板、角色资料、世界状态或检索索引发生变化时，系统仅清除受影响的缓存条目，避免过度清理并确保后续结果最新。

**Why this priority**: 新鲜度与正确性是业务可信度的底线，需要精确可控的失效粒度。

**Independent Test**: 触发各类变更事件（模板更新/索引重建/角色资料更新），验证仅相关键被清除，且后续请求重新计算并更新缓存。

**Acceptance Scenarios**:
1. Given 模板版本升级，When 触发失效事件，Then 仅含该模板标签的条目被清理，其他版本保持命中能力。
2. Given 索引版本变更，When 触发失效事件，Then 旧版本相关缓存失效，新版本请求重新计算并写入。

---

### User Story 3 - 流式回放一致性（SSE/WebSocket） (Priority: P2)
对正在流式返回的请求，新的订阅者可以即时回放已产生的片段并无缝跟随实时流；仅在完成时写入最终缓存，避免“半成品读”。

**Why this priority**: 保证多人/多端同时观察时的一致性与体验流畅。

**Independent Test**: 并发订阅同一请求的流式响应，验证回放片段、完成标记与最终整合写入的一致性。

**Acceptance Scenarios**:
1. Given 存在进行中的流式响应，When 新的订阅者加入，Then 先回放历史片段，再继续实时流。
2. Given 流式结束，When 完成标记设置，Then 写入入口缓存并可被后续请求命中；片段缓存按策略回收。

---

### User Story 4 - 并发风暴保护与复用（Single-Flight） (Priority: P2)
大量并发请求命中同一键时，系统合并为单次上游调用，其他请求等待同一结果，避免提供方调用风暴与穿透。

**Why this priority**: 抑制高峰期的上游压力与成本，提升整体吞吐与稳定性。

**Independent Test**: 模拟高并发相同键请求，验证只有一次上游调用，所有请求收到相同结果且延迟可控。

**Acceptance Scenarios**:
1. Given N 个并发同键请求，When 协调器接收，Then 合并为单飞任务并广播结果，记录合并统计。
2. Given 上游失败或限流，When 触发退避与负缓存，Then 后续短期重复请求被快速失败并退避重试。

---

### Edge Cases
- 相似度不足或语义漂移过大时，强制回退提供方，禁止冒进复用。
- 模板/索引/模型任一维度不一致，禁止跨边界复用。
- 流式中断或超时，片段缓存应按策略清理，避免脏读。
- 高并发下的竞争条件：完成写入与失效事件重叠时，以最新标签为准。
- 敏感/隐私请求的缓存策略：默认不持久化且受标签管控。

## Requirements *(mandatory)*

### Functional Requirements
- **FR-001** 统一键规范：系统必须对影响输出的全部因素进行规范化入键，包括但不限于角色、会话、提供方、模型名、模板 ID/版本、索引版本、区域语言、工具集合签名、停止符集合签名、解码参数分箱（温度、top_p、max_tokens）。
- **FR-002** 分箱规则：温度按 0.1；top_p 按 0.05；max_tokens 按 100 分箱，键中使用分箱值。
- **FR-003** 精确缓存：对完全一致的规范化键进行 O(1) 命中与 TTL 控制；仅在完成态写入，不缓存半成品。
- **FR-004** 语义缓存双阈值：相似度≥0.92（高阈值）直接命中；<0.85（低阈值）直接 miss；介于两者进行守卫检查（模板/工具一致、长度差≤15%、关键词重叠≥0.40）通过才命中。
- **FR-005** 语义边界：禁止跨模型名、模板版本、索引版本、日期分区复用；语义条目需携带新鲜度/陈旧度分数，超过阈值自动失效。
- **FR-006** 事件驱动失效：所有缓存条目必须附带标签（如 character、tmpl、tmplv、idxv、model、locale、tool、session/date），失效服务按标签组合精确清理。
- **FR-007** 流式一致性：支持片段回放与完成标记；仅在完成时写入精确与语义缓存；片段缓存具备 TTL 与孤儿清理。
- **FR-008** 并发合并：相同精确键的并发请求合并为单飞任务；提供合并计数与节省统计。
- **FR-009** 批量与去抖：在可控时间窗内合并同键请求进入同一批次；批次内结果按请求一一对应返回。
- **FR-010** 穿透防护：对持续失败/限流的键设置短 TTL 负缓存；采用指数退避与抖动；对键/提供方粒度限速。
- **FR-011** 可观测性：提供命中率（精确/语义/工具）、相似度分布、平均相应时间、单飞合并次数、重放次数、失效次数、缓存大小与淘汰量等指标。
- **FR-012** 预算闭环：对命中产生的节省（tokens/成本）进行估算并纳入效果报表。
- **FR-013** 配置开关：可分别启用/禁用精确缓存、语义缓存、单飞、流式回放与片段缓存，并可调整双阈值、TTL、相似度策略。
- **FR-014** 隐私与合规：敏感请求默认不持久化；支持以标签或策略排除持久化并按需加密存储或直接内存态。
- **FR-015** 回退路径：命中失败或灰区未通过守卫检查时，回退到提供方；提供方失败时，按策略执行重试/回退与负缓存。

### Key Entities *(include if feature involves data)*
- **CacheKey**：由规范化维度与内容摘要组成（哈希仅用于摘要，不承载隐私）。
- **CacheEntry**：值、TTL/时间戳、命中/访问计数、创建成本估计、标签、相似度元数据、完成标记（流式）。
- **SimilarityResult**：相似度分数、候选标识、守卫检查结果与原因。
- **Event**：模板更新、索引重建、角色更新、模型配置变更、世界状态变更等，携带触发标签。
- **ChunkRecord**：流式片段序号、偏移、时间戳、完成标记。
- **MetricsSnapshot**：命中率、相似度分布、延迟、节省估算、合并/回放/失效统计。

## Constitution Alignment *(mandatory)*
- **Domain-Driven Narrative Core**: 将缓存与协调能力归于“平台/加速器”上下文，对领域规则（模板/索引/角色）以事件与标签保持解耦；如需更新 ADR，记录缓存键规范与失效策略。
- **Contract-First Experience APIs**: 对外契约不变；若新增观测/统计接口，需补充契约文档与兼容性校验。
- **Data Stewardship & Persistence Discipline**: 规范键不包含敏感原文；持久化遵从最小必要原则；按标签控制保留周期与多租户隔离。
- **Quality Engineering & Testing Discipline**: 覆盖精确/语义命中边界、阈值灰区、事件失效、流式合并、单飞与负缓存的系统测试；达成既定覆盖目标。
- **Operability, Security & Reliability**: 提供可观测指标、告警阈值；限速与退避防止上游风暴；敏感数据不落盘或加密。
- **Documentation & Knowledge Stewardship**: 更新运行手册、故障排查与调优指南，记录阈值与标签策略；在治理手册登记。
- Workbook Reference: docs/governance/constitution-checks.md （创建后链接）

## Success Criteria *(mandatory)*

### Measurable Outcomes
- **SC-001** 首屏命中率（精确+语义合计）≥ 40%（上线 2 周内），且“错误复用”0 起。
- **SC-002** P50 响应时间较基线降低 ≥ 35%，P95 降低 ≥ 20%。
- **SC-003** 端到端成本较基线降低 ≥ 25%，并提供月度节省报表。
- **SC-004** 模板/索引/角色变更后，相关缓存清理延迟 ≤ 5 秒，且不出现跨版本复用。
- **SC-005** 流式回放一致性：并发订阅下“缺片/乱序/半成品读”发生率为 0（在抽样 1000 次会话测试中）。
- **SC-006** 并发风暴保护：相同键高并发压测下，单飞合并率 ≥ 90%，上游调用不超过 1 次/批。

## Assumptions
- 未指定外部向量服务，采用可插拔策略，后续可替换为任意实现；本规范保持技术无关。
- 模板/索引/角色等版本号由现有系统提供，事件来源可对接现有变更流水。
- 对高风险场景（支付、风控）默认关闭持久化与语义命中。
