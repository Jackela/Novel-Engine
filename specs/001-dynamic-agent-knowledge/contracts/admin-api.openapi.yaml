openapi: 3.0.3
info:
  title: Knowledge Management Admin API
  description: Admin API for managing agent knowledge entries in the Novel Engine knowledge base
  version: 1.0.0
  contact:
    name: Novel Engine Team

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server
  - url: https://api.novel-engine.example.com/api/v1
    description: Production server

security:
  - novelEngineAuth: []

paths:
  /knowledge/entries:
    get:
      summary: List knowledge entries
      description: Retrieve all knowledge entries with optional filtering
      operationId: listKnowledgeEntries
      tags:
        - Knowledge Management
      parameters:
        - name: owning_character_id
          in: query
          description: Filter by owning character ID
          required: false
          schema:
            type: string
        - name: knowledge_type
          in: query
          description: Filter by knowledge type
          required: false
          schema:
            $ref: '#/components/schemas/KnowledgeType'
        - name: access_level
          in: query
          description: Filter by access level
          required: false
          schema:
            $ref: '#/components/schemas/AccessLevel'
        - name: limit
          in: query
          description: Maximum number of entries to return
          required: false
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000
        - name: offset
          in: query
          description: Number of entries to skip (pagination)
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  entries:
                    type: array
                    items:
                      $ref: '#/components/schemas/KnowledgeEntry'
                  total:
                    type: integer
                    description: Total count of entries matching filters
                  limit:
                    type: integer
                  offset:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    post:
      summary: Create knowledge entry
      description: Create a new knowledge entry (FR-002)
      operationId: createKnowledgeEntry
      tags:
        - Knowledge Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateKnowledgeEntryRequest'
      responses:
        '201':
          description: Knowledge entry created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KnowledgeEntry'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /knowledge/entries/{entry_id}:
    get:
      summary: Get knowledge entry by ID
      description: Retrieve a specific knowledge entry
      operationId: getKnowledgeEntry
      tags:
        - Knowledge Management
      parameters:
        - $ref: '#/components/parameters/EntryId'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KnowledgeEntry'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    put:
      summary: Update knowledge entry
      description: Update an existing knowledge entry (FR-003)
      operationId: updateKnowledgeEntry
      tags:
        - Knowledge Management
      parameters:
        - $ref: '#/components/parameters/EntryId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateKnowledgeEntryRequest'
      responses:
        '200':
          description: Knowledge entry updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KnowledgeEntry'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    
    delete:
      summary: Delete knowledge entry
      description: Delete a knowledge entry (FR-004)
      operationId: deleteKnowledgeEntry
      tags:
        - Knowledge Management
      parameters:
        - $ref: '#/components/parameters/EntryId'
      responses:
        '204':
          description: Knowledge entry deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /knowledge/migrate:
    post:
      summary: Migrate Markdown files to knowledge base
      description: Trigger manual migration from Markdown files (FR-016)
      operationId: migrateMarkdownFiles
      tags:
        - Migration
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                verification_mode:
                  type: boolean
                  default: false
                  description: If true, verify migration without committing changes
      responses:
        '200':
          description: Migration completed or verification successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [completed, verified]
                  entries_migrated:
                    type: integer
                  backup_location:
                    type: string
                  errors:
                    type: array
                    items:
                      type: object
                      properties:
                        file_path:
                          type: string
                        error_message:
                          type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /knowledge/rollback:
    post:
      summary: Rollback migration to Markdown files
      description: Restore system to use Markdown files (FR-018)
      operationId: rollbackMigration
      tags:
        - Migration
      responses:
        '200':
          description: Rollback completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [completed]
                  backup_restored:
                    type: string
                    description: Backup timestamp that was restored
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    novelEngineAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Novel Engine authentication system (existing auth with admin/game_master role)

  parameters:
    EntryId:
      name: entry_id
      in: path
      description: Unique knowledge entry ID (UUID)
      required: true
      schema:
        type: string
        format: uuid

  schemas:
    KnowledgeType:
      type: string
      enum:
        - profile
        - objective
        - memory
        - lore
        - rules
      description: Type of knowledge entry

    AccessLevel:
      type: string
      enum:
        - public
        - role_based
        - character_specific
      description: Access control level

    AccessControlRule:
      type: object
      required:
        - access_level
      properties:
        access_level:
          $ref: '#/components/schemas/AccessLevel'
        allowed_roles:
          type: array
          items:
            type: string
          description: List of roles permitted to access (required for role_based access)
        allowed_character_ids:
          type: array
          items:
            type: string
          description: List of character IDs permitted to access (required for character_specific access)

    KnowledgeEntry:
      type: object
      required:
        - id
        - content
        - knowledge_type
        - access_control
        - created_at
        - updated_at
        - created_by
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier
        content:
          type: string
          minLength: 1
          description: Knowledge content text
        knowledge_type:
          $ref: '#/components/schemas/KnowledgeType'
        owning_character_id:
          type: string
          nullable: true
          description: Character this knowledge belongs to (null for world knowledge)
        access_control:
          $ref: '#/components/schemas/AccessControlRule'
        created_at:
          type: string
          format: date-time
          description: Creation timestamp (ISO 8601)
        updated_at:
          type: string
          format: date-time
          description: Last modification timestamp (ISO 8601)
        created_by:
          type: string
          description: User ID who created this entry

    CreateKnowledgeEntryRequest:
      type: object
      required:
        - content
        - knowledge_type
        - access_control
      properties:
        content:
          type: string
          minLength: 1
          maxLength: 100000
          description: Knowledge content text
        knowledge_type:
          $ref: '#/components/schemas/KnowledgeType'
        owning_character_id:
          type: string
          nullable: true
          description: Character this knowledge belongs to (null for world knowledge)
        access_control:
          $ref: '#/components/schemas/AccessControlRule'

    UpdateKnowledgeEntryRequest:
      type: object
      minProperties: 1
      properties:
        content:
          type: string
          minLength: 1
          maxLength: 100000
          description: Updated knowledge content text
        access_control:
          $ref: '#/components/schemas/AccessControlRule'

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error context

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: bad_request
            message: Content cannot be empty

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: unauthorized
            message: Authentication token missing or invalid

    Forbidden:
      description: Insufficient permissions (not admin or game_master role)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: forbidden
            message: User does not have admin or game_master role

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: not_found
            message: Knowledge entry not found

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: internal_server_error
            message: An unexpected error occurred
