name: Local Test Validation

on:
  push:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-tests:
    runs-on: ubuntu-22.04
    container: python:3.12
    
    steps:
    - name: Install dependencies
      shell: bash
      run: |
        echo "🐍 Installing Python dependencies..."
        python --version
        pip install --upgrade pip
        pip install pytest pytest-asyncio pytest-cov pytest-mock
        pip install pydantic fastapi uvicorn aiosqlite jinja2
        pip install redis aioredis
        echo "✅ Dependencies installed"
        
    - name: Show environment
      shell: bash
      run: |
        echo "📊 Environment Information"
        echo "=========================="
        pwd
        ls -la
        python --version
        pip list | grep pytest
        
    - name: Run Phase 2 exception tests
      shell: bash
      run: |
        echo "🧪 Running Phase 2 custom exception tests..."
        if [ -d "tests/unit/core" ]; then
          python -m pytest tests/unit/core/test_exceptions.py -v --tb=short || echo "⚠️ Exception tests failed"
        else
          echo "⚠️ Test directory not found"
        fi
        
    - name: Run Iron Laws integration tests  
      shell: bash
      run: |
        echo "🧪 Running Iron Laws integration tests..."
        if [ -d "tests/unit/core" ]; then
          python -m pytest tests/unit/core/test_iron_laws_processor.py::TestIronLawsIntegration -v --tb=short || echo "⚠️ Iron Laws tests failed"
        else
          echo "⚠️ Test directory not found"
        fi
        
    - name: Run sample unit tests
      shell: bash
      run: |
        echo "🧪 Running sample unit tests..."
        if [ -d "tests/unit" ]; then
          python -m pytest tests/unit/ -v --tb=no -q -x || echo "⚠️ Some tests failed"
        else
          echo "⚠️ Test directory not found"
        fi
        
    - name: Test summary
      if: always()
      run: |
        echo "📊 Test Validation Summary"
        echo "=========================="
        echo "✅ Act CLI workflow execution completed"
        echo "Check output above for test results"
