{
  "project": "Novel-Engine-Op-Resilience",
  "branchName": "refactor/brain-optimization",
  "description": "OPERATION RESILIENCE: Fix skipped tests, complete backend stubs, resolve API contract issues, and improve infrastructure.",
  "techContext": {
    "stack": "FastAPI + ChromaDB + Redis (mocked) + React (shadcn/ui + Zustand)",
    "testCommand": "pytest && npm --prefix frontend run test:e2e",
    "typecheckCommand": "mypy --strict src/contexts/knowledge && npm --prefix frontend run type-check",
    "conventions": "Strict Hexagonal Architecture, contract-first (schemas -> OpenAPI -> frontend types), structured logging via structlog, shadcn/ui + Tailwind-only styling, required UI states (loading/empty/error/ready)."
  },
  "userStories": [
    {
      "id": "RES-001",
      "title": "API: Fix /api/api/ Path Duplication",
      "description": "Fix 20 endpoints with /api/api/ double prefix in OpenAPI spec.",
      "acceptanceCriteria": [
        "Run: grep -c '/api/api/' docs/api/openapi.json → should be 0",
        "Fix router prefixes in src/api/routers/*.py",
        "Regenerate: python scripts/generate_openapi.py",
        "Verify: curl http://localhost:8000/health returns 200 (not 404)",
        "Update frontend/src/types/schemas.ts if paths changed"
      ],
      "verification": "grep '/api/api/' docs/api/openapi.json; echo 'Exit code:' $?  # Should exit 1 (not found)",
      "priority": 1,
      "passes": false,
      "effort": "low",
      "files": ["src/api/routers/*.py", "docs/api/openapi.json", "frontend/src/types/schemas.ts"]
    },
    {
      "id": "RES-002",
      "title": "API: Add Standard Error Response Schemas",
      "description": "Create ErrorDetail, ValidationError schemas in src/api/schemas.py.",
      "acceptanceCriteria": [
        "Add ErrorDetail schema with fields: code, message, details (optional dict)",
        "Add ValidationError schema extending ErrorDetail with field_errors",
        "Register HTTPException handlers in src/api/app.py for 400, 404, 422, 500",
        "All error responses use same envelope: {\"error\": ErrorDetail}",
        "Add test: tests/api/test_error_schemas.py with 5 test cases"
      ],
      "verification": "pytest tests/api/test_error_schemas.py -v",
      "priority": 2,
      "passes": false,
      "effort": "low",
      "files": ["src/api/schemas.py", "src/api/app.py", "tests/api/test_error_schemas.py"],
      "referencePattern": "See existing schemas in src/api/schemas.py for style"
    },
    {
      "id": "RES-003",
      "title": "Frontend: Add Node.js Version Enforcement",
      "description": "Add Node >= 18 requirement to package.json and CI.",
      "acceptanceCriteria": [
        "Add to frontend/package.json: \"engines\": {\"node\": \">=18.0.0\"}",
        "Create frontend/.nvmrc with content: \"20\"",
        "Add preinstall script: 'node -v | grep -q v1[89]\\|v2[0-9] || exit 1'",
        "Verify: npm install shows warning on Node 16 (if testable)"
      ],
      "verification": "cat frontend/package.json | grep -A1 'engines' && cat frontend/.nvmrc",
      "priority": 3,
      "passes": false,
      "effort": "low",
      "files": ["frontend/package.json", "frontend/.nvmrc"]
    },
    {
      "id": "RES-004",
      "title": "Infrastructure: Add Health Check Endpoints",
      "description": "Create /health/live and /health/ready endpoints.",
      "acceptanceCriteria": [
        "Add GET /health/live returning {\"status\": \"ok\"} with 200",
        "Add GET /health/ready checking ChromaDB connection",
        "Both endpoints in src/api/routers/health.py (update existing)",
        "Add test: tests/api/test_health_endpoints.py",
        "Response time < 100ms for /health/live"
      ],
      "verification": "pytest tests/api/test_health_endpoints.py -v && curl -s localhost:8000/health/live",
      "priority": 4,
      "passes": false,
      "effort": "low",
      "files": ["src/api/routers/health.py", "tests/api/test_health_endpoints.py"]
    },
    {
      "id": "RES-005",
      "title": "API: Sync Frontend-Backend Schemas",
      "description": "Run schema sync audit and fix all mismatches.",
      "acceptanceCriteria": [
        "Run: python scripts/audit_schema_sync.py → 0 mismatches",
        "If mismatches found, update frontend/src/types/schemas.ts",
        "Add CI check in .github/workflows/ that runs audit_schema_sync.py",
        "Document in CLAUDE.md: 'After API changes, run audit_schema_sync.py'"
      ],
      "verification": "python scripts/audit_schema_sync.py; echo 'Exit:' $?",
      "priority": 5,
      "passes": false,
      "effort": "low",
      "files": ["frontend/src/types/schemas.ts", "scripts/audit_schema_sync.py"],
      "blockedBy": ["RES-001"]
    },
    {
      "id": "RES-006",
      "title": "Test: Fix Skipped Knowledge Context Tests",
      "description": "Fix skipped tests in tests/unit/contexts/knowledge/ (baseline: ~30 skipped).",
      "acceptanceCriteria": [
        "Run: pytest tests/unit/contexts/knowledge/ --collect-only -q 2>/dev/null | grep -c skip",
        "Target: Reduce skipped count by 50% (from ~30 to ~15 or fewer)",
        "Common fixes: Add mock fixtures for ChromaDB, embedding services",
        "Do NOT remove tests - either fix or add proper skipif with reason",
        "Update conftest.py with any new fixtures needed"
      ],
      "verification": "pytest tests/unit/contexts/knowledge/ -v --tb=no 2>&1 | tail -5",
      "priority": 6,
      "passes": false,
      "effort": "medium",
      "files": ["tests/unit/contexts/knowledge/", "tests/conftest.py"],
      "baseline": {
        "skippedTests": 30,
        "targetReduction": "50%"
      }
    },
    {
      "id": "RES-007",
      "title": "Test: Fix Skipped World Context Tests",
      "description": "Fix skipped tests in tests/unit/contexts/world/ (baseline: ~20 skipped).",
      "acceptanceCriteria": [
        "Run: pytest tests/unit/contexts/world/ --collect-only -q 2>/dev/null | grep -c skip",
        "Target: Reduce skipped count by 50% (from ~20 to ~10 or fewer)",
        "Focus on: test_world_state_aggregate.py, test_faction.py",
        "Add fixtures for in-memory repositories"
      ],
      "verification": "pytest tests/unit/contexts/world/ -v --tb=no 2>&1 | tail -5",
      "priority": 7,
      "passes": false,
      "effort": "medium",
      "files": ["tests/unit/contexts/world/"]
    },
    {
      "id": "RES-008",
      "title": "Backend: Implement WorldStateAggregate.save()",
      "description": "Replace NotImplementedError in WorldStateAggregate.save() method.",
      "acceptanceCriteria": [
        "File: src/contexts/world/domain/aggregates/world_state.py",
        "Implement save() to serialize state to JSON file",
        "Use Result[None, SaveError] return pattern",
        "Add unit test: test_world_state_aggregate.py::test_save",
        "Max 50 lines of code for implementation"
      ],
      "verification": "pytest tests/unit/contexts/world/domain/test_world_state_aggregate.py::test_save -v",
      "priority": 8,
      "passes": false,
      "effort": "low",
      "files": ["src/contexts/world/domain/aggregates/world_state.py", "tests/unit/contexts/world/domain/test_world_state_aggregate.py"],
      "referencePattern": "See save() pattern in src/contexts/character/domain/aggregates/character.py"
    },
    {
      "id": "RES-009",
      "title": "Backend: Implement InMemoryLoreEntryRepository.search()",
      "description": "Replace pass statement in search() method with actual search logic.",
      "acceptanceCriteria": [
        "File: src/contexts/world/infrastructure/persistence/in_memory_lore_entry_repository.py",
        "Implement search(query: str) -> list[LoreEntry]",
        "Use simple substring match (no fancy search needed)",
        "Add unit test: test_lore_entry.py::test_repository_search",
        "Return empty list if no matches (not exception)"
      ],
      "verification": "pytest tests/unit/contexts/world/infrastructure/test_in_memory_lore_entry_repository.py -v -k search",
      "priority": 9,
      "passes": false,
      "effort": "low",
      "files": ["src/contexts/world/infrastructure/persistence/in_memory_lore_entry_repository.py"]
    },
    {
      "id": "RES-010",
      "title": "Infrastructure: Add Structlog to Remaining Modules",
      "description": "Replace print() and logging.* with structlog in src/core/ modules.",
      "acceptanceCriteria": [
        "Run: grep -r 'print(' src/core/ | wc -l → should decrease by 80%",
        "Run: grep -r 'logging\\.info\\|logging\\.debug\\|logging\\.warning' src/core/ | wc -l → 0",
        "Use pattern: logger = structlog.get_logger(); logger.info('event_name', key=value)",
        "Do NOT change tests/ directory",
        "Max 5 files to update in this story"
      ],
      "verification": "grep -c 'print(' src/core/*.py 2>/dev/null | grep -v ':0$' | wc -l",
      "priority": 10,
      "passes": false,
      "effort": "medium",
      "files": ["src/core/*.py"],
      "baseline": {
        "printStatements": "count before starting",
        "targetReduction": "80%"
      }
    },
    {
      "id": "RES-011",
      "title": "Frontend: Fix Flaky Dashboard E2E Tests",
      "description": "Fix tests in frontend/tests/e2e/dashboard-*.spec.ts with retry/timeout issues.",
      "acceptanceCriteria": [
        "Files: frontend/tests/e2e/dashboard-core-uat.spec.ts, dashboard-extended-uat.spec.ts",
        "Replace waitForTimeout with waitForSelector where possible",
        "Add data-testid attributes to slow-loading elements",
        "Each test should have max 30s timeout",
        "Run 3x locally - all should pass"
      ],
      "verification": "cd frontend && npm run test:e2e -- --grep 'dashboard' --retries=0 2>&1 | tail -10",
      "priority": 11,
      "passes": false,
      "effort": "medium",
      "files": ["frontend/tests/e2e/dashboard-*.spec.ts", "frontend/src/features/dashboard/"]
    },
    {
      "id": "RES-012",
      "title": "Test: Remove Abandoned TDD Placeholders",
      "description": "Remove or implement TDD placeholder tests with no corresponding feature.",
      "acceptanceCriteria": [
        "Find: grep -r '@pytest.mark.skip.*TDD\\|TODO.*test' tests/unit/",
        "For each: check if feature exists in src/",
        "If feature exists: implement test",
        "If feature abandoned: remove test with comment in commit",
        "Target: Reduce TDD skips by 30% (baseline ~40)"
      ],
      "verification": "pytest tests/unit/ --collect-only -q 2>/dev/null | grep -i 'tdd\\|placeholder' | wc -l",
      "priority": 12,
      "passes": false,
      "effort": "medium",
      "files": ["tests/unit/"]
    },
    {
      "id": "RES-013",
      "title": "Backend: Implement MemoryStore CRUD",
      "description": "Implement basic CRUD in src/contexts/character/infrastructure/persistence/memory_store.py.",
      "acceptanceCriteria": [
        "Implement: store(memory_id, content, metadata) -> None",
        "Implement: retrieve(memory_id) -> MemoryEntry | None",
        "Implement: delete(memory_id) -> bool",
        "Use dict-based in-memory storage (no external DB)",
        "Add test: test_memory_store.py with 5 test cases"
      ],
      "verification": "pytest tests/unit/contexts/character/infrastructure/test_memory_store.py -v",
      "priority": 13,
      "passes": false,
      "effort": "medium",
      "files": ["src/contexts/character/infrastructure/persistence/memory_store.py", "tests/unit/contexts/character/infrastructure/test_memory_store.py"]
    },
    {
      "id": "RES-014",
      "title": "Tech Debt: Audit Root-Level Compatibility Files",
      "description": "Review src/character_factory.py, src/director_agent.py for deprecation status.",
      "acceptanceCriteria": [
        "Check if files are imported anywhere (grep -r 'from src.character_factory' .)",
        "If used: add deprecation warning with migration path",
        "If unused: add to .gitignore candidate list (don't delete yet)",
        "Update CLAUDE.md with migration guidance",
        "Create tracking issue for removal in next version"
      ],
      "verification": "grep -r 'from src.character_factory\\|from src.director_agent' src/ tests/ | wc -l",
      "priority": 14,
      "passes": false,
      "effort": "low",
      "files": ["src/character_factory.py", "src/director_agent.py", "src/director_agent_integrated.py"]
    },
    {
      "id": "RES-015",
      "title": "Docs: Update Architecture Diagrams",
      "description": "Update docs/architecture/*.mermaid to reflect current code structure.",
      "acceptanceCriteria": [
        "Verify rag_pipeline.mermaid matches current service names",
        "Add memory_flow.mermaid for RES-013 implementation",
        "All class names in diagrams exist in codebase",
        "Regenerate PNG if Makefile target exists"
      ],
      "verification": "grep -f <(ls src/contexts/knowledge/application/services/*.py | xargs -I{} basename {} .py) docs/architecture/rag_pipeline.mermaid | wc -l",
      "priority": 15,
      "passes": false,
      "effort": "low",
      "files": ["docs/architecture/*.mermaid"],
      "blockedBy": ["RES-013"]
    }
  ]
}
