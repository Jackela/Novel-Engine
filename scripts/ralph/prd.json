{
  "project": "Novel-Engine-Op-Resilience",
  "branchName": "refactor/brain-optimization",
  "description": "OPERATION RESILIENCE: Fix skipped tests, complete backend stubs, resolve API contract issues, and improve infrastructure before production deployment.",
  "techContext": {
    "stack": "FastAPI + ChromaDB + Redis (mocked) + React (shadcn/ui + Zustand)",
    "testCommand": "pytest && npm --prefix frontend run test:e2e",
    "typecheckCommand": "mypy --strict src/contexts/knowledge && npm --prefix frontend run type-check",
    "conventions": "Strict Hexagonal Architecture, contract-first (schemas -> OpenAPI -> frontend types), structured logging via structlog, shadcn/ui + Tailwind-only styling, and required UI states (loading/empty/error/ready). Extract large classes into composable strategies."
  },
  "userStories": [
    {
      "id": "RES-001",
      "title": "Test: Fix Environment-Dependent Skipped Tests",
      "description": "Enable and fix tests skipped due to missing environment variables or services.",
      "acceptanceCriteria": [
        "Audit all tests marked with @pytest.mark.skip(reason contains 'env', 'CI', 'redis', 'database') across the codebase.",
        "Create mock fixtures or test doubles for external services (Redis, Neo4j, ChromaDB) where appropriate.",
        "Add environment variable guards with skipif conditions that check for actual availability.",
        "Ensure at least 80% of previously skipped tests now run and pass in CI.",
        "Document required environment setup in tests/conftest.py docstrings."
      ],
      "priority": 1,
      "passes": false,
      "effort": "high",
      "notes": "Focus on knowledge context tests first as they are most critical for RAG."
    },
    {
      "id": "RES-002",
      "title": "Test: Fix TDD Placeholder Tests",
      "description": "Implement or remove tests that were skipped as TDD placeholders.",
      "acceptanceCriteria": [
        "Identify all tests with skip markers containing 'TODO', 'TDD', 'placeholder', or 'not implemented'.",
        "For each placeholder: either implement the test with proper assertions, or remove if the feature was abandoned.",
        "Ensure implemented tests follow the AAA pattern (Arrange-Act-Assert) and have descriptive names.",
        "No test file should have more than 10% placeholder skips after completion.",
        "Update test count metrics in test_pyramid_monitor to reflect changes."
      ],
      "priority": 2,
      "passes": false,
      "effort": "high",
      "notes": "Prioritize tests in src/contexts/ as they test core business logic."
    },
    {
      "id": "RES-003",
      "title": "Test: Fix Dependency-Related Skipped Tests",
      "description": "Resolve tests skipped due to missing optional dependencies.",
      "acceptanceCriteria": [
        "Audit tests skipped due to missing imports (try/except ImportError patterns).",
        "Add missing optional dependencies to requirements.txt or mark as truly optional in pyproject.toml extras.",
        "Create integration test markers (e.g., @pytest.mark.integration_chromadb) for tests requiring specific services.",
        "Document dependency requirements in test file docstrings.",
        "Update CI workflow to run integration tests when services are available."
      ],
      "priority": 3,
      "passes": false,
      "effort": "medium",
      "notes": "Common missing deps: neo4j, chromadb, tiktoken, rank_bm25"
    },
    {
      "id": "RES-004",
      "title": "Backend: Complete WorldStateManager Implementation",
      "description": "Replace stub implementations in world_state_manager with working code.",
      "acceptanceCriteria": [
        "Identify all NotImplementError, pass, and TODO comments in src/contexts/world modules.",
        "Implement world state persistence with proper serialization.",
        "Add proper error handling with Result<T,E> pattern.",
        "Create integration tests for state persistence and retrieval.",
        "Document the world state schema and lifecycle in docstrings."
      ],
      "priority": 4,
      "passes": false,
      "effort": "high",
      "notes": "Coordinate with any Weaver UI that depends on world state."
    },
    {
      "id": "RES-005",
      "title": "Backend: Complete Memory Interface Implementation",
      "description": "Implement memory layer interfaces currently marked as stubs.",
      "acceptanceCriteria": [
        "Audit memory_interface, episodic_memory, semantic_memory modules for stub implementations.",
        "Implement CRUD operations for character memories with proper storage.",
        "Add memory decay/relevance scoring algorithms.",
        "Create unit tests with mocked storage backends.",
        "Ensure memory retrieval integrates with RAG pipeline."
      ],
      "priority": 5,
      "passes": false,
      "effort": "high",
      "notes": "Memory is critical for character consistency in narratives."
    },
    {
      "id": "RES-006",
      "title": "Backend: Complete Narrative Stream Service",
      "description": "Implement narrative_stream_service for real-time story updates.",
      "acceptanceCriteria": [
        "Replace placeholder SSE implementation with proper Server-Sent Events.",
        "Implement narrative event publishing and subscription.",
        "Add connection management and reconnection handling.",
        "Create integration tests for stream lifecycle.",
        "Document API contract for frontend integration."
      ],
      "priority": 6,
      "passes": false,
      "effort": "medium",
      "notes": "Used by ChatInterface for real-time story generation."
    },
    {
      "id": "RES-007",
      "title": "API: Fix OpenAPI Path Duplication",
      "description": "Resolve /api/api/ double-prefix issue in OpenAPI specification.",
      "acceptanceCriteria": [
        "Audit docs/api/openapi.json for paths containing /api/api/ prefix.",
        "Fix FastAPI router configuration to use correct path prefixes.",
        "Regenerate openapi.json with corrected paths.",
        "Update frontend/src/types/schemas.ts to match corrected API.",
        "Verify all API routes work correctly after fix.",
        "Add CI check to prevent future path duplication."
      ],
      "priority": 7,
      "passes": false,
      "effort": "low",
      "notes": "Currently 20 endpoints have /api/api/ duplication."
    },
    {
      "id": "RES-008",
      "title": "API: Add Missing Error Response Schemas",
      "description": "Define and document all API error response schemas.",
      "acceptanceCriteria": [
        "Create ErrorDetail, ValidationError, and NotFoundError schemas in src/api/schemas.py.",
        "Add HTTPException handlers for common error codes (400, 401, 403, 404, 422, 500, 503).",
        "Document all error responses in OpenAPI specification.",
        "Ensure frontend has typed error handling for each schema.",
        "Add request validation tests that verify error response shapes."
      ],
      "priority": 8,
      "passes": false,
      "effort": "medium",
      "notes": "Essential for frontend error handling and user feedback."
    },
    {
      "id": "RES-009",
      "title": "API: Validate Frontend-Backend Schema Alignment",
      "description": "Ensure frontend schemas exactly match backend OpenAPI spec.",
      "acceptanceCriteria": [
        "Run scripts/audit_schema_sync.py and fix all mismatches.",
        "Create CI check that fails on schema drift.",
        "Document schema sync process in CLAUDE.md.",
        "Add pre-commit hook for schema validation.",
        "Ensure all API changes include schema updates as part of the PR."
      ],
      "priority": 9,
      "passes": false,
      "effort": "medium",
      "notes": "Use openapi-typescript for frontend generation."
    },
    {
      "id": "RES-010",
      "title": "Infrastructure: Redis Integration Hardening",
      "description": "Replace Redis mocks with configurable real/mocked implementation.",
      "acceptanceCriteria": [
        "Create RedisConfig value object with connection pooling.",
        "Implement graceful degradation when Redis is unavailable.",
        "Add health check endpoint for Redis connectivity.",
        "Create integration tests with real Redis (docker-compose).",
        "Document Redis setup in README.md infrastructure section.",
        "Add Redis connection metrics to monitoring dashboard."
      ],
      "priority": 10,
      "passes": false,
      "effort": "high",
      "notes": "Critical for caching and session management."
    },
    {
      "id": "RES-011",
      "title": "Infrastructure: Structured Logging Standardization",
      "description": "Ensure all modules use structlog consistently.",
      "acceptanceCriteria": [
        "Audit all log statements across src/ for structlog usage.",
        "Replace any print() or logging.info() with structlog.get_logger().",
        "Add correlation IDs to all log entries for request tracing.",
        "Create log level standards document (DEBUG vs INFO vs WARN vs ERROR).",
        "Add log sampling for high-volume endpoints.",
        "Ensure PII is never logged (add sensitive field filtering)."
      ],
      "priority": 11,
      "passes": false,
      "effort": "medium",
      "notes": "Essential for production debugging and observability."
    },
    {
      "id": "RES-012",
      "title": "Infrastructure: Health Check Endpoints",
      "description": "Implement comprehensive health check system.",
      "acceptanceCriteria": [
        "Create /health/live (liveness) and /health/ready (readiness) endpoints.",
        "Check dependencies: ChromaDB, Redis, PostgreSQL (if configured).",
        "Return detailed component status in /health/ready response.",
        "Add timeout handling for dependency checks.",
        "Document health check contracts for Kubernetes integration.",
        "Create integration tests for health check scenarios."
      ],
      "priority": 12,
      "passes": false,
      "effort": "low",
      "notes": "Required for production deployment and auto-scaling."
    },
    {
      "id": "RES-013",
      "title": "Frontend: Add Node.js Version Requirement",
      "description": "Document and enforce Node.js version requirements.",
      "acceptanceCriteria": [
        "Add engines field to frontend/package.json requiring Node >= 18.",
        "Add .nvmrc file with recommended Node version.",
        "Update CI workflow to check Node version.",
        "Add pre-install script that warns on incompatible Node versions.",
        "Document Node requirements in README.md and frontend/README.md."
      ],
      "priority": 13,
      "passes": false,
      "effort": "low",
      "notes": "esbuild and other deps require Node 18+."
    },
    {
      "id": "RES-014",
      "title": "Frontend: E2E Test Stability Improvements",
      "description": "Fix flaky E2E tests and improve reliability.",
      "acceptanceCriteria": [
        "Identify all E2E tests with retry patterns or timeout issues.",
        "Add proper wait conditions using Playwright's waitFor* methods.",
        "Implement test isolation with proper cleanup between tests.",
        "Add network idle checks before assertions.",
        "Create E2E debugging guide in tests/e2e/README.md.",
        "Reduce E2E test flake rate to < 5%."
      ],
      "priority": 14,
      "passes": false,
      "effort": "medium",
      "notes": "Focus on dashboard and chat tests first."
    },
    {
      "id": "RES-015",
      "title": "Tech Debt: Remove Deprecated Code",
      "description": "Clean up deprecated functions and modules.",
      "acceptanceCriteria": [
        "Search for @deprecated, DEPRECATED, deprecation_warning patterns.",
        "Remove or replace deprecated code that has alternatives.",
        "Update all import references to use current modules.",
        "Add migration notes to CHANGELOG.md for any breaking changes.",
        "Run full test suite to ensure no regressions."
      ],
      "priority": 15,
      "passes": false,
      "effort": "medium",
      "notes": "Check root-level compatibility files (character_factory.py, director_agent.py)."
    }
  ]
}
