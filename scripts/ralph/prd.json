{
  "project": "Novel-Engine-Op-Resilience",
  "branchName": "refactor/brain-optimization",
  "description": "OPERATION RESILIENCE: Fix skipped tests, complete backend stubs, resolve API contract issues, and improve infrastructure.",
  "techContext": {
    "stack": "FastAPI + ChromaDB + Redis (mocked) + React (shadcn/ui + Zustand)",
    "testCommand": "pytest && npm --prefix frontend run test:e2e",
    "typecheckCommand": "mypy --strict src/contexts/knowledge && npm --prefix frontend run type-check",
    "conventions": "Strict Hexagonal Architecture, contract-first (schemas -> OpenAPI -> frontend types), structured logging via structlog, shadcn/ui + Tailwind-only styling, required UI states (loading/empty/error/ready)."
  },
  "userStories": [
    {
      "id": "RES-001",
      "title": "API: Add ErrorDetail Schema",
      "description": "Add single ErrorDetail schema to src/api/schemas.py.",
      "acceptanceCriteria": [
        "Add class ErrorDetail(BaseModel) with fields: code (str), message (str), details (dict | None = None)",
        "Add example in schema: {\"code\": \"NOT_FOUND\", \"message\": \"Resource not found\"}",
        "Run: mypy src/api/schemas.py passes"
      ],
      "verification": "grep -A5 'class ErrorDetail' src/api/schemas.py",
      "priority": 1,
      "passes": true,
      "effort": "low",
      "files": ["src/api/schemas.py"],
      "estimatedTime": "15 min"
    },
    {
      "id": "RES-002",
      "title": "API: Add ValidationError Schema",
      "description": "Add ValidationError extending ErrorDetail.",
      "acceptanceCriteria": [
        "Add class ValidationError(ErrorDetail) with field: field_errors (dict[str, list[str]] | None = None)",
        "Add example showing field validation errors"
      ],
      "verification": "grep -A3 'class ValidationError' src/api/schemas.py",
      "priority": 2,
      "passes": true,
      "effort": "low",
      "files": ["src/api/schemas.py"],
      "estimatedTime": "10 min",
      "blockedBy": ["RES-001"]
    },
    {
      "id": "RES-003",
      "title": "API: Add 404 Exception Handler",
      "description": "Add HTTPException handler for 404 in app.py.",
      "acceptanceCriteria": [
        "Add @app.exception_handler(404) returning ErrorDetail",
        "Test: curl localhost:8000/nonexistent returns {\"error\": {\"code\": \"NOT_FOUND\"...}}"
      ],
      "verification": "grep -A10 'exception_handler.*404' src/api/app.py",
      "priority": 3,
      "passes": false,
      "effort": "low",
      "files": ["src/api/app.py"],
      "estimatedTime": "20 min",
      "blockedBy": ["RES-001"]
    },
    {
      "id": "RES-004",
      "title": "Frontend: Add Node.js Engines Field",
      "description": "Add engines field to package.json.",
      "acceptanceCriteria": [
        "Add: \"engines\": {\"node\": \">=18.0.0\", \"npm\": \">=9.0.0\"}",
        "npm install should warn on Node 16 (can't test locally)"
      ],
      "verification": "grep -A2 '\"engines\"' frontend/package.json",
      "priority": 4,
      "passes": false,
      "effort": "low",
      "files": ["frontend/package.json"],
      "estimatedTime": "5 min"
    },
    {
      "id": "RES-005",
      "title": "Frontend: Add .nvmrc File",
      "description": "Create .nvmrc with Node 20.",
      "acceptanceCriteria": [
        "Create frontend/.nvmrc with single line: \"20\"",
        "nvm use should work in frontend/ directory"
      ],
      "verification": "cat frontend/.nvmrc",
      "priority": 5,
      "passes": false,
      "effort": "low",
      "files": ["frontend/.nvmrc"],
      "estimatedTime": "2 min"
    },
    {
      "id": "RES-006",
      "title": "Infrastructure: Add /health/live Endpoint",
      "description": "Add liveness probe endpoint.",
      "acceptanceCriteria": [
        "GET /health/live returns {\"status\": \"ok\"}",
        "Response in < 10ms",
        "Add to src/api/routers/health.py"
      ],
      "verification": "grep -A5 'def live' src/api/routers/health.py || grep -A5 '/health/live' src/api/routers/health.py",
      "priority": 6,
      "passes": false,
      "effort": "low",
      "files": ["src/api/routers/health.py"],
      "estimatedTime": "10 min"
    },
    {
      "id": "RES-007",
      "title": "Infrastructure: Add /health/ready Endpoint",
      "description": "Add readiness probe with ChromaDB check.",
      "acceptanceCriteria": [
        "GET /health/ready checks ChromaDB connection",
        "Returns {\"status\": \"ok\", \"checks\": {\"chromadb\": \"ok\"}} on success",
        "Returns 503 with error details on failure"
      ],
      "verification": "grep -A10 'def ready' src/api/routers/health.py || grep -A10 '/health/ready' src/api/routers/health.py",
      "priority": 7,
      "passes": false,
      "effort": "low",
      "files": ["src/api/routers/health.py"],
      "estimatedTime": "20 min"
    },
    {
      "id": "RES-008",
      "title": "API: Fix Router Prefix in auth.py",
      "description": "Remove duplicate /api prefix in auth router.",
      "acceptanceCriteria": [
        "File: src/api/routers/auth.py",
        "If router has prefix='/api/auth', change to prefix='/auth'",
        "Verify: grep 'prefix=' src/api/routers/auth.py"
      ],
      "verification": "grep \"prefix=\" src/api/routers/auth.py",
      "priority": 8,
      "passes": false,
      "effort": "low",
      "files": ["src/api/routers/auth.py"],
      "estimatedTime": "5 min"
    },
    {
      "id": "RES-009",
      "title": "API: Fix Router Prefix in characters.py",
      "description": "Remove duplicate /api prefix in characters router.",
      "acceptanceCriteria": [
        "File: src/api/routers/characters.py",
        "If router has prefix='/api/characters', change to prefix='/characters'"
      ],
      "verification": "grep \"prefix=\" src/api/routers/characters.py",
      "priority": 9,
      "passes": false,
      "effort": "low",
      "files": ["src/api/routers/characters.py"],
      "estimatedTime": "5 min"
    },
    {
      "id": "RES-010",
      "title": "API: Fix Router Prefix in generation.py",
      "description": "Remove duplicate /api prefix in generation router.",
      "acceptanceCriteria": [
        "File: src/api/routers/generation.py",
        "Fix prefix if duplicated"
      ],
      "verification": "grep \"prefix=\" src/api/routers/generation.py",
      "priority": 10,
      "passes": false,
      "effort": "low",
      "files": ["src/api/routers/generation.py"],
      "estimatedTime": "5 min"
    },
    {
      "id": "RES-011",
      "title": "API: Regenerate OpenAPI Spec",
      "description": "Run generate_openapi.py after router fixes.",
      "acceptanceCriteria": [
        "Run: python scripts/generate_openapi.py",
        "Verify: grep -c '/api/api/' docs/api/openapi.json should be 0"
      ],
      "verification": "grep -c '/api/api/' docs/api/openapi.json || echo '0 (good)'",
      "priority": 11,
      "passes": false,
      "effort": "low",
      "files": ["docs/api/openapi.json"],
      "estimatedTime": "5 min",
      "blockedBy": ["RES-008", "RES-009", "RES-010"]
    },
    {
      "id": "RES-012",
      "title": "Backend: Implement WorldStateAggregate.save()",
      "description": "Replace NotImplementedError in save() method.",
      "acceptanceCriteria": [
        "File: src/contexts/world/domain/aggregates/world_state.py",
        "Implement save() to serialize to JSON",
        "Use Result[None, SaveError] pattern",
        "Add one test case"
      ],
      "verification": "grep -A20 'def save' src/contexts/world/domain/aggregates/world_state.py | head -25",
      "priority": 12,
      "passes": false,
      "effort": "low",
      "files": ["src/contexts/world/domain/aggregates/world_state.py"],
      "estimatedTime": "30 min",
      "referencePattern": "See Result pattern in src/contexts/character/"
    },
    {
      "id": "RES-013",
      "title": "Backend: Implement LoreRepository.search()",
      "description": "Implement search() in InMemoryLoreEntryRepository.",
      "acceptanceCriteria": [
        "File: src/contexts/world/infrastructure/persistence/in_memory_lore_entry_repository.py",
        "Implement search(query: str) -> list[LoreEntry]",
        "Use simple substring match",
        "Return [] if no matches"
      ],
      "verification": "grep -A15 'def search' src/contexts/world/infrastructure/persistence/in_memory_lore_entry_repository.py",
      "priority": 13,
      "passes": false,
      "effort": "low",
      "files": ["src/contexts/world/infrastructure/persistence/in_memory_lore_entry_repository.py"],
      "estimatedTime": "20 min"
    },
    {
      "id": "RES-014",
      "title": "Backend: Implement MemoryStore.store()",
      "description": "Implement single store() method in MemoryStore.",
      "acceptanceCriteria": [
        "File: src/contexts/character/infrastructure/persistence/memory_store.py (create if needed)",
        "store(memory_id: str, content: str, metadata: dict) -> None",
        "Use self._store: dict as backend"
      ],
      "verification": "grep -A10 'def store' src/contexts/character/infrastructure/persistence/memory_store.py 2>/dev/null || echo 'File not found'",
      "priority": 14,
      "passes": false,
      "effort": "low",
      "files": ["src/contexts/character/infrastructure/persistence/memory_store.py"],
      "estimatedTime": "15 min"
    },
    {
      "id": "RES-015",
      "title": "Backend: Implement MemoryStore.retrieve()",
      "description": "Implement retrieve() method in MemoryStore.",
      "acceptanceCriteria": [
        "retrieve(memory_id: str) -> MemoryEntry | None",
        "Return None if not found (no exception)"
      ],
      "verification": "grep -A10 'def retrieve' src/contexts/character/infrastructure/persistence/memory_store.py",
      "priority": 15,
      "passes": false,
      "effort": "low",
      "files": ["src/contexts/character/infrastructure/persistence/memory_store.py"],
      "estimatedTime": "10 min",
      "blockedBy": ["RES-014"]
    },
    {
      "id": "RES-016",
      "title": "Backend: Implement MemoryStore.delete()",
      "description": "Implement delete() method in MemoryStore.",
      "acceptanceCriteria": [
        "delete(memory_id: str) -> bool",
        "Return True if deleted, False if not found"
      ],
      "verification": "grep -A10 'def delete' src/contexts/character/infrastructure/persistence/memory_store.py",
      "priority": 16,
      "passes": false,
      "effort": "low",
      "files": ["src/contexts/character/infrastructure/persistence/memory_store.py"],
      "estimatedTime": "10 min",
      "blockedBy": ["RES-014"]
    },
    {
      "id": "RES-017",
      "title": "Test: Fix 3 Skipped Tests in test_bm25_retriever.py",
      "description": "Fix up to 3 skipped tests in BM25 retriever tests.",
      "acceptanceCriteria": [
        "File: tests/unit/contexts/knowledge/application/services/test_bm25_retriever.py",
        "Fix 3 skipped tests by adding proper mocks",
        "pytest this file should show fewer skips"
      ],
      "verification": "pytest tests/unit/contexts/knowledge/application/services/test_bm25_retriever.py -v --tb=no 2>&1 | grep -E 'PASSED|SKIPPED|FAILED' | head -20",
      "priority": 17,
      "passes": false,
      "effort": "low",
      "files": ["tests/unit/contexts/knowledge/application/services/test_bm25_retriever.py"],
      "estimatedTime": "30 min"
    },
    {
      "id": "RES-018",
      "title": "Test: Fix 3 Skipped Tests in test_hybrid_retriever.py",
      "description": "Fix up to 3 skipped tests in hybrid retriever.",
      "acceptanceCriteria": [
        "File: tests/unit/contexts/knowledge/application/services/test_hybrid_retriever.py",
        "Fix 3 skipped tests"
      ],
      "verification": "pytest tests/unit/contexts/knowledge/application/services/test_hybrid_retriever.py -v --tb=no 2>&1 | grep -E 'PASSED|SKIPPED|FAILED' | head -20",
      "priority": 18,
      "passes": false,
      "effort": "low",
      "files": ["tests/unit/contexts/knowledge/application/services/test_hybrid_retriever.py"],
      "estimatedTime": "30 min"
    },
    {
      "id": "RES-019",
      "title": "Test: Fix 3 Skipped Tests in test_rerank_service.py",
      "description": "Fix up to 3 skipped tests in rerank service.",
      "acceptanceCriteria": [
        "File: tests/unit/contexts/knowledge/application/services/test_rerank_service.py",
        "Fix 3 skipped tests"
      ],
      "verification": "pytest tests/unit/contexts/knowledge/application/services/test_rerank_service.py -v --tb=no 2>&1 | grep -E 'PASSED|SKIPPED|FAILED' | head -20",
      "priority": 19,
      "passes": false,
      "effort": "low",
      "files": ["tests/unit/contexts/knowledge/application/services/test_rerank_service.py"],
      "estimatedTime": "30 min"
    },
    {
      "id": "RES-020",
      "title": "Logging: Replace print() in agent_coordinator.py",
      "description": "Replace print statements with structlog in one file.",
      "acceptanceCriteria": [
        "File: src/core/agent_coordinator.py",
        "Replace all print() with logger.info/error",
        "Add: logger = structlog.get_logger() at top"
      ],
      "verification": "grep -c 'print(' src/core/agent_coordinator.py",
      "priority": 20,
      "passes": false,
      "effort": "low",
      "files": ["src/core/agent_coordinator.py"],
      "estimatedTime": "15 min"
    },
    {
      "id": "RES-021",
      "title": "Logging: Replace print() in turn_orchestrator.py",
      "description": "Replace print statements with structlog in one file.",
      "acceptanceCriteria": [
        "File: src/core/turn_orchestrator.py",
        "Replace all print() with structlog"
      ],
      "verification": "grep -c 'print(' src/core/turn_orchestrator.py",
      "priority": 21,
      "passes": false,
      "effort": "low",
      "files": ["src/core/turn_orchestrator.py"],
      "estimatedTime": "15 min"
    },
    {
      "id": "RES-022",
      "title": "Logging: Replace print() in narrative_processor.py",
      "description": "Replace print statements with structlog in one file.",
      "acceptanceCriteria": [
        "File: src/core/narrative_processor.py",
        "Replace all print() with structlog"
      ],
      "verification": "grep -c 'print(' src/core/narrative_processor.py",
      "priority": 22,
      "passes": false,
      "effort": "low",
      "files": ["src/core/narrative_processor.py"],
      "estimatedTime": "15 min"
    },
    {
      "id": "RES-023",
      "title": "Frontend: Fix Flaky Dashboard Core Test",
      "description": "Fix flaky test in dashboard-core-uat.spec.ts.",
      "acceptanceCriteria": [
        "File: frontend/tests/e2e/dashboard-core-uat.spec.ts",
        "Replace waitForTimeout with waitForSelector",
        "Add data-testid to slow elements if needed"
      ],
      "verification": "grep -c 'waitForTimeout' frontend/tests/e2e/dashboard-core-uat.spec.ts",
      "priority": 23,
      "passes": false,
      "effort": "low",
      "files": ["frontend/tests/e2e/dashboard-core-uat.spec.ts"],
      "estimatedTime": "20 min"
    },
    {
      "id": "RES-024",
      "title": "Tech Debt: Check character_factory.py Usage",
      "description": "Check if character_factory.py is still imported anywhere.",
      "acceptanceCriteria": [
        "Run: grep -r 'from src.character_factory' src/ tests/",
        "If 0 results: mark for removal in notes",
        "If used: add deprecation warning to file"
      ],
      "verification": "grep -r 'from src.character_factory' src/ tests/ | wc -l",
      "priority": 24,
      "passes": false,
      "effort": "low",
      "files": ["src/character_factory.py"],
      "estimatedTime": "10 min"
    },
    {
      "id": "RES-025",
      "title": "Tech Debt: Check director_agent.py Usage",
      "description": "Check if director_agent.py is still imported anywhere.",
      "acceptanceCriteria": [
        "Run: grep -r 'from src.director_agent' src/ tests/",
        "If 0 results: mark for removal in notes",
        "If used: add deprecation warning to file"
      ],
      "verification": "grep -r 'from src.director_agent' src/ tests/ | wc -l",
      "priority": 25,
      "passes": false,
      "effort": "low",
      "files": ["src/director_agent.py"],
      "estimatedTime": "10 min"
    }
  ]
}
