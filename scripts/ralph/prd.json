{
  "project": "Novel-Engine-Warzone-4-AI-Brain",
  "branchName": "feat/code-citadel",
  "description": "WARZONE 4: Building the RAG (Retrieval-Augmented Generation) engine and Prompt Engineering Lab. Enabling long-term memory for the AI system through ChromaDB vector storage, multi-LLM support, and knowledge graph capabilities.",
  "techContext": {
    "stack": "FastAPI + ChromaDB + OpenAI/Anthropic/Gemini + React",
    "testCommand": "pytest tests/ && npm run test:e2e",
    "typecheckCommand": "mypy . && npm run type-check",
    "conventions": "TDD/BDD approach: Write failing test first, implement minimum code, verify with E2E. Strict adherence to CONVENTIONS.md (Hexagonal Arch) and DESIGN_SYSTEM.md."
  },
  "userStories": [
    {
      "id": "BRAIN-035B-01",
      "title": "Dashboard: Model Comparison Table",
      "description": "Add cost comparison table for different models.",
      "acceptanceCriteria": [
        "Create model comparison table component",
        "Display cost per 1M tokens for each model",
        "Group by provider (OpenAI, Anthropic, Gemini, Ollama)",
        "Typecheck passes"
      ],
      "priority": 60,
      "passes": true,
      "notes": ""
    },
    {
      "id": "BRAIN-035B-02",
      "title": "Dashboard: Date Range Filter",
      "description": "Add date range filter for analytics charts.",
      "acceptanceCriteria": [
        "Add date range picker component to Usage tab",
        "Filter applies to all charts and stats",
        "Default to last 30 days",
        "Typecheck passes"
      ],
      "priority": 61,
      "passes": true,
      "dependencies": ["BRAIN-035B-01"],
      "notes": ""
    },
    {
      "id": "BRAIN-035B-03",
      "title": "Dashboard: CSV Export",
      "description": "Export usage report as CSV file.",
      "acceptanceCriteria": [
        "Add export button to Usage tab",
        "Generate CSV with timestamp, model, tokens, cost columns",
        "Respect date range filter",
        "Typecheck passes"
      ],
      "priority": 62,
      "passes": true,
      "dependencies": ["BRAIN-035B-02"],
      "notes": ""
    },
    {
      "id": "BRAIN-035B-04",
      "title": "Dashboard: Real-time Usage Counter",
      "description": "Show live token usage during generation.",
      "acceptanceCriteria": [
        "Add real-time counter in UI",
        "Update via WebSocket or polling during generation",
        "Display current session tokens and cost",
        "Typecheck passes"
      ],
      "priority": 63,
      "passes": true,
      "notes": ""
    },
    {
      "id": "BRAIN-036-01",
      "title": "Context Inspector: Button Placement",
      "description": "Add View AI Context button to scene editor.",
      "acceptanceCriteria": [
        "Add button in Director scene editor toolbar",
        "Button only visible when RAG is enabled",
        "Typecheck passes"
      ],
      "priority": 64,
      "passes": true,
      "notes": ""
    },
    {
      "id": "BRAIN-036-02",
      "title": "Context Inspector: Panel Component",
      "description": "Create context inspector panel UI.",
      "acceptanceCriteria": [
        "Create sliding panel component",
        "Show retrieved chunks with source info",
        "Display relevance scores",
        "Show token count per chunk",
        "Typecheck passes"
      ],
      "priority": 65,
      "passes": true,
      "dependencies": ["BRAIN-036-01"],
      "notes": ""
    },
    {
      "id": "BRAIN-036-03",
      "title": "Context Inspector: Highlight Used Chunks",
      "description": "Indicate which chunks were used in generation.",
      "acceptanceCriteria": [
        "Highlight chunks that contributed to response",
        "Visual distinction between used and unused chunks",
        "Typecheck passes"
      ],
      "priority": 66,
      "passes": true,
      "dependencies": ["BRAIN-036-02"],
      "notes": ""
    },
    {
      "id": "BRAIN-036-04",
      "title": "Context Inspector: Manual Chunk Selection",
      "description": "Allow manually selecting chunks for regeneration.",
      "acceptanceCriteria": [
        "Add checkboxes to chunk list",
        "Regenerate button passes selected chunks to RAG",
        "Typecheck passes"
      ],
      "priority": 67,
      "passes": true,
      "dependencies": ["BRAIN-036-03"],
      "notes": ""
    },
    {
      "id": "BRAIN-036-05",
      "title": "Context Inspector: Context Window Display",
      "description": "Show context window usage vs limit.",
      "acceptanceCriteria": [
        "Display progress bar for context window usage",
        "Show percentage and token count",
        "Warning when approaching limit",
        "Typecheck passes"
      ],
      "priority": 68,
      "passes": true,
      "dependencies": ["BRAIN-036-02"],
      "notes": ""
    },
    {
      "id": "BRAIN-037A-01",
      "title": "Chat Backend: POST Endpoint",
      "description": "Create /api/brain/chat endpoint.",
      "acceptanceCriteria": [
        "Create POST /api/brain/chat endpoint",
        "Accept query parameter and optional chat history",
        "Return streaming response",
        "Test: Endpoint returns 200"
      ],
      "priority": 69,
      "passes": true,
      "notes": ""
    },
    {
      "id": "BRAIN-037A-02",
      "title": "Chat Backend: RAG Integration",
      "description": "Wire up RAG for chat responses.",
      "acceptanceCriteria": [
        "Call RetrievalService with user query",
        "Inject retrieved context into LLM prompt",
        "Test: Answer uses knowledge base content"
      ],
      "priority": 70,
      "passes": true,
      "dependencies": ["BRAIN-037A-01"],
      "notes": "RAG integration was implemented as part of BRAIN-037A-01"
    },
    {
      "id": "BRAIN-037A-03",
      "title": "Chat Backend: Conversational Context",
      "description": "Support multi-turn chat with history.",
      "acceptanceCriteria": [
        "Store chat history per session",
        "Include previous messages in RAG query",
        "Test: Context maintained across turns"
      ],
      "priority": 71,
      "passes": true,
      "dependencies": ["BRAIN-037A-02"],
      "notes": ""
    },
    {
      "id": "BRAIN-037A-04",
      "title": "Chat Backend: Streaming",
      "description": "Stream responses for better UX.",
      "acceptanceCriteria": [
        "Use SSE for streaming tokens",
        "Test: Streaming works end-to-end"
      ],
      "priority": 72,
      "passes": true,
      "dependencies": ["BRAIN-037A-03"],
      "notes": "Streaming was already implemented as part of BRAIN-037A-01"
    },
    {
      "id": "BRAIN-037B-01",
      "title": "Chat UI: Floating Widget",
      "description": "Create floating chat interface.",
      "acceptanceCriteria": [
        "Create ChatInterface component",
        "Position fixed bottom-right",
        "Collapsible when not in use",
        "Typecheck passes"
      ],
      "priority": 73,
      "passes": true,
      "dependencies": ["BRAIN-037A-04"],
      "notes": "Implemented floating widget with MessageSquare toggle button, collapsible Card panel, and minimize/expand functionality"
    },
    {
      "id": "BRAIN-037B-02",
      "title": "Chat UI: Message Display",
      "description": "Display chat messages and handle input.",
      "acceptanceCriteria": [
        "Show user and AI messages in different styles",
        "Auto-scroll to latest message",
        "Input field with send button",
        "Typecheck passes",
        "Verify in browser"
      ],
      "priority": 74,
      "passes": false,
      "dependencies": ["BRAIN-037B-01"],
      "notes": ""
    },
    {
      "id": "BRAIN-038-01",
      "title": "Smart Tagging: Service Setup",
      "description": "Create auto-tagging service.",
      "acceptanceCriteria": [
        "Create SmartTaggingService in knowledge context",
        "Method: generate_tags(content, content_type) -> list[str]",
        "Use LLM for tag generation",
        "Test: Generate tags for sample content"
      ],
      "priority": 75,
      "passes": false,
      "notes": ""
    },
    {
      "id": "BRAIN-038-02",
      "title": "Smart Tagging: Tag Categories",
      "description": "Define tag categories for different content types.",
      "acceptanceCriteria": [
        "Support categories: genre, mood, themes, characters_present, locations",
        "Category-specific tag generation prompts",
        "Test: Generate tags for each category"
      ],
      "priority": 76,
      "passes": false,
      "dependencies": ["BRAIN-038-01"],
      "notes": ""
    },
    {
      "id": "BRAIN-038-03",
      "title": "Smart Tagging: Auto-trigger",
      "description": "Trigger tagging on content creation/update.",
      "acceptanceCriteria": [
        "Add event handlers for LoreCreated, LoreUpdated, SceneCreated, SceneUpdated",
        "Handlers call SmartTaggingService",
        "Store tags in entity metadata",
        "Test: Create scene and verify tags generated"
      ],
      "priority": 77,
      "passes": false,
      "dependencies": ["BRAIN-038-02"],
      "notes": ""
    },
    {
      "id": "BRAIN-038-04",
      "title": "Smart Tagging: Metadata Storage",
      "description": "Store tags in metadata for filtering.",
      "acceptanceCriteria": [
        "Add tags field to entity metadata",
        "Support tag search/filter",
        "Test: Filter by tag returns matching entities"
      ],
      "priority": 78,
      "passes": false,
      "dependencies": ["BRAIN-038-03"],
      "notes": ""
    },
    {
      "id": "BRAIN-038-05",
      "title": "Smart Tagging: Manual Override",
      "description": "Allow manual tag editing.",
      "acceptanceCriteria": [
        "Add UI for editing tags",
        "Manual edits persist (not overwritten by auto-tagging)",
        "Test: Manual tag persists after entity update"
      ],
      "priority": 79,
      "passes": false,
      "dependencies": ["BRAIN-038-04"],
      "notes": ""
    },
    {
      "id": "BRAIN-039A-01",
      "title": "Chunking: Strategy Interface",
      "description": "Define chunking strategy interface.",
      "acceptanceCriteria": [
        "Create IChunkingStrategy port",
        "Method: chunk(text, config) -> list[Chunk]",
        "Define Chunk entity with text, index, metadata",
        "Test: Interface implementation"
      ],
      "priority": 80,
      "passes": false,
      "notes": ""
    },
    {
      "id": "BRAIN-039A-02",
      "title": "Chunking: Fixed Strategy",
      "description": "Implement fixed-size chunking.",
      "acceptanceCriteria": [
        "Create FixedChunkingStrategy",
        "Config: chunk_size, overlap",
        "Test: Chunk 2000 words with 500 size, 50 overlap"
      ],
      "priority": 81,
      "passes": false,
      "dependencies": ["BRAIN-039A-01"],
      "notes": ""
    },
    {
      "id": "BRAIN-039A-03",
      "title": "Chunking: Sentence/Paragraph Strategies",
      "description": "Implement sentence and paragraph chunking.",
      "acceptanceCriteria": [
        "Create SentenceChunkingStrategy",
        "Create ParagraphChunkingStrategy",
        "Test: Chunk by sentence boundaries"
      ],
      "priority": 82,
      "passes": false,
      "dependencies": ["BRAIN-039A-02"],
      "notes": ""
    },
    {
      "id": "BRAIN-039A-04",
      "title": "Chunking: Semantic Strategy",
      "description": "Implement semantic-aware chunking.",
      "acceptanceCriteria": [
        "Create SemanticChunkingStrategy using embeddings",
        "Group semantically related sentences",
        "Test: Semantic chunks are coherent"
      ],
      "priority": 83,
      "passes": false,
      "dependencies": ["BRAIN-039A-03"],
      "notes": ""
    },
    {
      "id": "BRAIN-039A-05",
      "title": "Chunking: Auto-detection",
      "description": "Auto-select best strategy by content type.",
      "acceptanceCriteria": [
        "Map content types to strategies: Scene->Semantic, Character->Paragraph",
        "Auto-detect strategy based on content structure",
        "Test: Correct strategy selected per content type"
      ],
      "priority": 84,
      "passes": false,
      "dependencies": ["BRAIN-039A-04"],
      "notes": ""
    },
    {
      "id": "BRAIN-039B-01",
      "title": "Chunking: Narrative Flow",
      "description": "Maintain narrative flow in chunks.",
      "acceptanceCriteria": [
        "Preserve sentence boundaries",
        "Don't break in middle of dialogue",
        "Test: Chunks maintain narrative coherence"
      ],
      "priority": 85,
      "passes": false,
      "dependencies": ["BRAIN-039A-05"],
      "notes": ""
    },
    {
      "id": "BRAIN-039B-02",
      "title": "Chunking: Configurable Overlap",
      "description": "Allow overlap size configuration.",
      "acceptanceCriteria": [
        "Add overlap parameter to chunking config",
        "Default overlap: 10% of chunk_size",
        "Test: Overlap creates expected context continuity"
      ],
      "priority": 86,
      "passes": false,
      "dependencies": ["BRAIN-039B-01"],
      "notes": ""
    },
    {
      "id": "BRAIN-039B-03",
      "title": "Chunking: Coherence Verification",
      "description": "Verify chunk semantic coherence.",
      "acceptanceCriteria": [
        "Add coherence score calculation",
        "Warn if chunks have low coherence",
        "Test: Coherence scoring works"
      ],
      "priority": 87,
      "passes": false,
      "dependencies": ["BRAIN-039B-02"],
      "notes": ""
    },
    {
      "id": "BRAIN-040A-01",
      "title": "E2E: Test File Setup",
      "description": "Create E2E test file structure.",
      "acceptanceCriteria": [
        "Create tests/e2e/brain-rag.spec.ts",
        "Setup Playwright test configuration",
        "Test: File runs without errors"
      ],
      "priority": 88,
      "passes": false,
      "dependencies": ["BRAIN-037B-02"],
      "notes": ""
    },
    {
      "id": "BRAIN-040A-02",
      "title": "E2E: Lore Entry Creation",
      "description": "Test: Create lore entry and wait for ingestion.",
      "acceptanceCriteria": [
        "Navigate to lore creation page",
        "Fill form and submit",
        "Wait for ingestion confirmation",
        "Test: Lore entry appears in knowledge base"
      ],
      "priority": 89,
      "passes": false,
      "dependencies": ["BRAIN-040A-01"],
      "notes": ""
    },
    {
      "id": "BRAIN-040A-03",
      "title": "E2E: Chat Verification",
      "description": "Test: Chat returns knowledge base content.",
      "acceptanceCriteria": [
        "Open chat interface",
        "Ask question about created lore",
        "Verify answer contains lore content",
        "Test: Basic RAG retrieval verified"
      ],
      "priority": 90,
      "passes": false,
      "dependencies": ["BRAIN-040A-02"],
      "notes": ""
    },
    {
      "id": "BRAIN-040B-01",
      "title": "E2E: Hybrid Search Test",
      "description": "Test: Hybrid search with traits.",
      "acceptanceCriteria": [
        "Create character with specific trait",
        "Search for trait using chat",
        "Verify character found via hybrid search",
        "Test: Hybrid search works"
      ],
      "priority": 91,
      "passes": false,
      "dependencies": ["BRAIN-040A-03"],
      "notes": ""
    },
    {
      "id": "BRAIN-040B-02",
      "title": "E2E: Citations Test",
      "description": "Test: Source citations are correct.",
      "acceptanceCriteria": [
        "Query that returns multiple sources",
        "Verify citations are displayed",
        "Click citation and verify source",
        "Test: Citations accurate"
      ],
      "priority": 92,
      "passes": false,
      "dependencies": ["BRAIN-040B-01"],
      "notes": ""
    },
    {
      "id": "BRAIN-040B-03",
      "title": "E2E: Multi-hop Test",
      "description": "Test: Multi-hop relationship traversal.",
      "acceptanceCriteria": [
        "Create connected entities (A->B->C)",
        "Ask question requiring traversal",
        "Verify answer uses multi-hop reasoning",
        "Test: Multi-hop retrieval works"
      ],
      "priority": 93,
      "passes": false,
      "dependencies": ["BRAIN-040B-02"],
      "notes": ""
    }
  ]
}
