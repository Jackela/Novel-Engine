{
  "project": "Novel-Engine-Code-Citadel",
  "branchName": "feat/code-citadel",
  "description": "OPERATION CODE CITADEL: Technical debt repayment, architectural strictness, performance optimization, and error handling standardization.",
  "techContext": {
    "stack": "FastAPI + React + Tailwind",
    "testCommand": "pytest tests/ && npm run test:e2e",
    "typecheckCommand": "mypy . && npm run type-check",
    "conventions": "READ CONVENTIONS.md AND DESIGN_SYSTEM.md BEFORE CODING. STRICTLY FOLLOW HEXAGONAL ARCHITECTURE."
  },
  "userStories": [
    {
      "id": "CIT-001",
      "title": "Backend: Schema Synchronization Audit",
      "description": "Audit and align all Pydantic backend schemas with Zod frontend schemas to eliminate contract drift.",
      "acceptanceCriteria": [
        "Run diff between src/api/schemas.py and frontend/src/types/schemas.ts",
        "Document all misaligned fields in docs/api/schema-drift-report.md",
        "Identify missing schemas (present in one but not the other)",
        "Create checklist of schema discrepancies with severity levels (CRITICAL/HIGH/LOW)",
        "Verify all field constraints match (min/max lengths, enums, validation rules)",
        "Run scripts/generate_openapi.py and regenerate frontend schemas",
        "Run npm run type-check - no schema-related errors",
        "Verification: All API contracts align between backend and frontend"
      ],
      "priority": 1,
      "passes": true,
      "effort": "medium"
    },
    {
      "id": "CIT-002",
      "title": "Frontend: Eliminate Duplicate Type Definitions",
      "description": "Remove duplicate type definitions from dtoTransforms.ts and establish single source of truth.",
      "acceptanceCriteria": [
        "Audit frontend/src/services/dtoTransforms.ts for duplicate types",
        "Move CombatStats, StructuredCharacterData, EquipmentItem to frontend/src/types/schemas.ts",
        "Import from schemas.ts instead of local definitions",
        "Update all imports across codebase to use centralized types",
        "Delete duplicate definitions from dtoTransforms.ts",
        "Keep only transformation functions (not types) in dtoTransforms",
        "Run npm run type-check - zero errors",
        "Run npm run lint:all - no unused imports"
      ],
      "priority": 2,
      "passes": true,
      "effort": "low"
    },
    {
      "id": "CIT-003",
      "title": "Backend: Establish Result Pattern Implementation",
      "description": "Implement consistent Result[T, E] pattern for error handling across all services.",
      "acceptanceCriteria": [
        "Create src/core/result.py with Result[T, E], Ok[T], Error[E] classes",
        "Add @dataclass for Error with code, message, recoverable fields",
        "Update 3 service files as reference implementations: orchestration_service.py, character_application_service.py, pacing_service.py",
        "Replace raw exception raising with Result returns",
        "Update routers to unwrap Results and return appropriate HTTP status codes",
        "Run pytest tests/unit/api/ - all service tests pass",
        "Document Result pattern in docs/architecture/error-handling.md"
      ],
      "priority": 3,
      "passes": true,
      "effort": "medium"
    },
    {
      "id": "CIT-004",
      "title": "Backend: Remove Character-Orchestration Coupling",
      "description": "Eliminate circular dependency between character context and orchestration context.",
      "acceptanceCriteria": [
        "Audit src/contexts/orchestration/infrastructure/pipeline_phases/__init__.py",
        "Identify what character-specific logic orchestration imports",
        "Create domain event in character context: CharacterInteractionRequested",
        "Emit event instead of direct import",
        "Subscribe orchestration to character domain events",
        "Remove all 'from src.contexts.character' imports from orchestration",
        "Add import-linter rule to prevent re-introduction",
        "Run pytest tests/unit/contexts/orchestration/ - all pass",
        "Run scripts/validate_imports.sh - zero violations"
      ],
      "priority": 4,
      "passes": false,
      "effort": "medium",
      "dependencies": ["CIT-003"]
    },
    {
      "id": "CIT-004.5",
      "title": "Backend: Extract Router Business Logic",
      "description": "Move business logic from routers to services layer. Characters router has ~600 lines with logic that belongs in services.",
      "acceptanceCriteria": [
        "Audit src/api/routers/characters.py - identify all business logic functions",
        "Create or update CharacterService with methods: gather_filesystem_character_info, summarize_workspace_character, summarize_public_character",
        "Move helper functions: _normalize_numeric_map, _to_float to services",
        "Move cache-related functions (_build_entity_etag, _apply_entity_cache_headers, _set_cache_headers) to a separate CacheService",
        "Update router to only handle: request parsing, response formatting, error handling",
        "Target: Router files max 200 lines, services handle business logic",
        "Run pytest tests/unit/api/routers/ - all pass"
      ],
      "priority": 5,
      "passes": false,
      "effort": "high",
      "dependencies": ["CIT-003"]
    },
    {
      "id": "CIT-005",
      "title": "Frontend: Consolidate State Management Strategy",
      "description": "Audit and document all Zustand stores, create consolidation plan.",
      "acceptanceCriteria": [
        "Inventory all Zustand stores: authStore, orchestrationStore, decisionStore, weaverStore (4 total)",
        "Document each store's purpose, state shape, actions in docs/architecture/state-management.md",
        "Identify overlapping responsibilities between stores",
        "Create consolidation strategy document",
        "Mark stores for: KEEP, MERGE, SPLIT, DEPRECATE",
        "Define migration path for store consolidation",
        "Run npm run type-check - no errors after documentation"
      ],
      "priority": 6,
      "passes": false,
      "effort": "high"
    },
    {
      "id": "CIT-006",
      "title": "Backend: Resolve TODOs",
      "description": "Systematically resolve or document all 15 backend TODO/FIXME comments.",
      "acceptanceCriteria": [
        "Extract all TODOs/FIXMEs from backend using grep",
        "Categorize each: IMPLEMENT NOW, DEFERRED, or DOCUMENTED LIMITATION",
        "Files with TODOs: src/api/knowledge_api.py (4), src/api/production_server.py (1), src/infrastructure/enterprise_storage_manager.py (1), src/contexts/character/application/commands/character_command_handlers.py (4), src/contexts/world/application/commands/handlers.py (1), src/contexts/knowledge/infrastructure/adapters/embedding_generator_adapter.py (2)",
        "For IMPLEMENT NOW: Implement the feature or fix",
        "For DEFERRED: Create GitHub issue with detailed task description",
        "For DOCUMENTED LIMITATION: Add explanatory comment why this is acceptable",
        "Run pytest after each resolved TODO",
        "Update docs/quality/todo-tracker.md with final status"
      ],
      "priority": 7,
      "passes": false,
      "effort": "medium"
    },
    {
      "id": "CIT-007",
      "title": "Frontend: Resolve TODOs",
      "description": "Resolve 2 frontend TODOs in PlotlineManager and NarrativeEditorLayout.",
      "acceptanceCriteria": [
        "Fix frontend/src/features/director/components/PlotlineManager.tsx:392 - Implement API call to GET /api/plotlines/{id}/scene-counts",
        "Add backend endpoint if missing",
        "Display real scene counts",
        "Fix frontend/src/components/narrative/NarrativeEditorLayout.tsx:246 - Import useToast from shadcn/ui, add toast notification on error state",
        "Run npm run type-check - no errors",
        "Run npm run test - all component tests pass"
      ],
      "priority": 8,
      "passes": false,
      "effort": "low"
    },
    {
      "id": "CIT-008",
      "title": "Docs: Create Missing ADRs",
      "description": "Document recent architectural decisions with proper ADRs.",
      "acceptanceCriteria": [
        "Create docs/adr/ADR-004-director-mode.md - Document Director workflow orchestration, scene critique agent integration, beat suggestion system",
        "Create docs/adr/ADR-005-state-management.md - Document Zustand store architecture, store splitting strategy, when to create new stores",
        "Create docs/adr/ADR-006-result-pattern.md - Document Result[T, E] error handling, migration from exceptions, provide examples",
        "Use ADR template from docs/adr/ADR-001-iron-laws-validation.md",
        "Update docs/adr/index.md with new ADRs"
      ],
      "priority": 9,
      "passes": false,
      "effort": "medium"
    },
    {
      "id": "CIT-009a",
      "title": "Test: Split test_narrative_context_value_object.py",
      "description": "Refactor oversized test file (2144 lines) into focused, maintainable modules.",
      "acceptanceCriteria": [
        "Split tests/unit/contexts/narratives/domain/test_narrative_context_value_object.py by method group",
        "Target: Each resulting test file max 500 lines",
        "Create shared test utilities module for common fixtures if applicable",
        "Run pytest tests/unit/contexts/narratives/domain/ - all tests still pass",
        "Update docs/testing/test-organization.md with new structure"
      ],
      "priority": 10,
      "passes": false,
      "effort": "medium"
    },
    {
      "id": "CIT-009b",
      "title": "Test: Split test_narrative_theme_value_object.py",
      "description": "Refactor oversized test file (1724 lines) into focused, maintainable modules.",
      "acceptanceCriteria": [
        "Split tests/unit/contexts/narratives/domain/test_narrative_theme_value_object.py by method group",
        "Target: Each resulting test file max 500 lines",
        "Use shared test utilities module created in CIT-009a if applicable",
        "Run pytest tests/unit/contexts/narratives/domain/ - all tests still pass",
        "Update docs/testing/test-organization.md with new structure"
      ],
      "priority": 11,
      "passes": false,
      "effort": "medium"
    },
    {
      "id": "CIT-009c",
      "title": "Test: Split test_causal_node_value_object.py",
      "description": "Refactor oversized test file (1662 lines) into focused, maintainable modules.",
      "acceptanceCriteria": [
        "Split tests/unit/contexts/narratives/domain/test_causal_node_value_object.py by method group",
        "Target: Each resulting test file max 500 lines",
        "Use shared test utilities module created in CIT-009a if applicable",
        "Run pytest tests/unit/contexts/narratives/domain/ - all tests still pass",
        "Update docs/testing/test-organization.md with new structure"
      ],
      "priority": 12,
      "passes": false,
      "effort": "medium"
    },
    {
      "id": "CIT-009d",
      "title": "Test: Split test_character_stats_value_object.py",
      "description": "Refactor oversized test file (1625 lines) into focused, maintainable modules.",
      "acceptanceCriteria": [
        "Split tests/unit/contexts/character/domain/test_character_stats_value_object.py by method group",
        "Target: Each resulting test file max 500 lines",
        "Create or use shared test utilities module for common fixtures",
        "Run pytest tests/unit/contexts/character/domain/ - all tests still pass",
        "Update docs/testing/test-organization.md with new structure"
      ],
      "priority": 13,
      "passes": false,
      "effort": "medium"
    },
    {
      "id": "CIT-010",
      "title": "Test: Add Integration Test Coverage",
      "description": "Expand integration test coverage for critical API paths.",
      "acceptanceCriteria": [
        "Add tests/integration/api/test_schema_sync.py - Verify all Pydantic schemas have corresponding Zod schemas, test field constraint alignment",
        "Add tests/integration/api/test_result_pattern.py - Verify Result pattern usage in all services, test error response format consistency",
        "Add tests/integration/contexts/test_character_orchestration_isolation.py - Verify no direct imports between contexts, test domain event propagation",
        "Run pytest tests/integration/ - all pass",
        "Add to CI pipeline"
      ],
      "priority": 14,
      "passes": false,
      "effort": "medium",
      "dependencies": ["CIT-003"]
    },
    {
      "id": "CIT-011",
      "title": "Frontend: Bundle Size Analysis & Optimization",
      "description": "Analyze frontend bundle and optimize for performance.",
      "acceptanceCriteria": [
        "Run npm run build and analyze bundle size",
        "Create bundle report in docs/reports/bundle-analysis-{date}.md",
        "Identify top 10 largest dependencies",
        "For dependencies > 100KB: Consider code splitting, evaluate tree-shaking, document lazy loading opportunities",
        "Add bundle size limit to CI (fail if increases > 5%)",
        "Implement route-based code splitting for /dashboard, /director, /weaver",
        "Run npm run build - verify reduced bundle sizes"
      ],
      "priority": 15,
      "passes": false,
      "effort": "medium",
      "dependencies": ["CIT-005"]
    },
    {
      "id": "CIT-012",
      "title": "Docs: Enhance CLAUDE.md Coverage",
      "description": "Add CLAUDE.md files to key directories lacking developer guidance.",
      "acceptanceCriteria": [
        "Create src/contexts/character/CLAUDE.md - Character entity lifecycle, domain events, service patterns, testing conventions",
        "Create src/contexts/narrative/CLAUDE.md - Story/Chapter/Scene hierarchy, beat and conflict modeling, pacing analysis usage",
        "Create frontend/src/features/director/CLAUDE.md - Director workflow architecture, scene editor state management, critique sidebar integration",
        "Create frontend/src/features/weaver/CLAUDE.md - React Flow graph setup, node visual protocol, edge interaction patterns",
        "Follow existing CLAUDE.md format with 'Why this module exists', 'Key patterns', 'Gotchas'"
      ],
      "priority": 16,
      "passes": false,
      "effort": "low",
      "dependencies": ["CIT-004", "CIT-005"]
    },
    {
      "id": "CIT-013",
      "title": "Docs: Create Architecture Decision Diagrams",
      "description": "Create visual diagrams for key architectural flows.",
      "acceptanceCriteria": [
        "Create docs/architecture/diagrams/director-flow.md (Mermaid) - Scene creation to Beat addition to AI suggestions to Critique",
        "Create docs/architecture/diagrams/context-communication.md - Show domain event flow between contexts, NO direct imports",
        "Create docs/architecture/diagrams/data-flow.md - Backend schema to OpenAPI to Frontend types",
        "Render diagrams to PNG in docs/assets/diagrams/",
        "Update ARCHITECTURE.md with diagram links"
      ],
      "priority": 17,
      "passes": false,
      "effort": "low",
      "dependencies": ["CIT-008"]
    },
    {
      "id": "CIT-014",
      "title": "CI: Establish Quality Metrics Dashboard",
      "description": "Create automated tracking of code quality metrics over time.",
      "acceptanceCriteria": [
        "Extend src/quality/code_quality_monitor.py - Add TODO/FIXME count tracking, test file size violations, import lint violations",
        "Create scripts/quality_report.py - Generate weekly quality metrics, output JSON with trend data",
        "Create docs/reports/quality-metrics.json - Historical quality data, commit to repo for tracking",
        "Add to CI: Fail if TODO count increases week-over-week",
        "Generate baseline report on first run",
        "Document metrics in docs/quality/metrics-definition.md"
      ],
      "priority": 18,
      "passes": false,
      "effort": "medium"
    },
    {
      "id": "CIT-015",
      "title": "Docs: Create Onboarding Checklist",
      "description": "Create comprehensive onboarding guide for new developers.",
      "acceptanceCriteria": [
        "Create docs/onboarding/first-week.md - Day 1: Setup, architecture overview, first bug fix. Day 2-3: Complete CIT-007. Day 4-5: Add test to CIT-009 suite",
        "Create docs/onboarding/architecture-deep-dive.md - Hexagonal architecture explanation, context boundaries, common patterns",
        "Create docs/onboarding/common-tasks.md - How to add API endpoint, schema field, UI component, write tests",
        "Include references to all ADRs and CLAUDE.md files",
        "Add checklist for PRD completion verification"
      ],
      "priority": 19,
      "passes": false,
      "effort": "low"
    },
    {
      "id": "CIT-016",
      "title": "Docs: Create Code Citadel Completion Report",
      "description": "Generate final report on technical debt repayment achievements.",
      "acceptanceCriteria": [
        "Create docs/reports/code-citadel-final-report.md - Summary: Stories completed (20/20), Before/After metrics, Architectural improvements",
        "Generate bundle size comparison report",
        "Document TODO count: 15 -> 0, Schema drift: X mismatches -> reduced, Test file sizes: Max 2144 lines -> max 500 lines, Documentation: ADRs added",
        "Update CLAUDE.md with lessons learned",
        "Archive Code Citadel campaign to scripts/ralph/archive/"
      ],
      "priority": 20,
      "passes": false,
      "effort": "low"
    }
  ]
}
