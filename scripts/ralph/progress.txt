# Ralph Progress - UI Rescue Phase

## UI-FIX-001 - 2026-01-30
- What I implemented: Fixed catch-all route redirect by changing path from '*' to '$' (TanStack Router splat syntax)
- Pattern discovered: TanStack Router uses '$' for splat/catch-all routes, not '*' like traditional routers
- Gotcha for future: The catch-all route was showing "Not Found" paragraph instead of redirecting because of wrong syntax. Always use '$' for TanStack Router wildcards.

## TEST-FIX-001 - 2026-01-30
- What I implemented: Fixed Playwright headless mode default and added browser cleanup in global teardown
- Changes made:
  1. Changed `headless: process.env.CI ? true : false` to `headless: process.env.HEADED !== 'true'` in both playwright configs
  2. Added `cleanupBrowserContexts()` function to global-teardown.ts that closes lingering browser contexts
  3. Added Windows-specific orphan process cleanup via taskkill
- Pattern discovered: Use inverted env var logic (HEADED=true to show browser) instead of CI detection for headless mode
- Gotcha for future: Always default to headless mode and use explicit opt-in for headed mode during debugging

## MOCK-001 - 2026-01-30
- What I implemented: LLM Mock Infrastructure for E2E Testing
- Files created:
  1. `tests/mocks/llm_handlers.ts` - Main mock implementation with Page route interceptors
  2. `frontend/tests/e2e/utils/llmMocks.ts` - ESM-compatible copy for Playwright tests
  3. `frontend/tests/e2e/llm-mock-verification.spec.ts` - Verification tests
- Endpoints mocked:
  - POST /api/generate
  - POST /api/generation/character
  - POST /api/generation/scene
  - POST /api/narratives/stream (SSE)
  - GET/POST /api/orchestration/narrative
- Pattern discovered: TypeScript files in `tests/` are CommonJS by default, Playwright tests in `frontend/tests/e2e/` require ESM. Need to maintain parallel implementations or use re-exports
- Gotcha for future: When using `page.route()` with `page.evaluate()`, cannot use `about:blank` as the page - need to navigate to actual app URL first for relative fetch URLs to work
- Verification: All 5 tests pass with MOCK_LLM=true in 8.1s, properly skipped when env var not set

## NAR-001 - 2026-01-31
- What I implemented: Story & Chapter domain entities for the Narrative bounded context
- Files created:
  1. `src/contexts/narrative/domain/__init__.py` - Domain layer exports
  2. `src/contexts/narrative/domain/entities/__init__.py` - Entities package
  3. `src/contexts/narrative/domain/entities/story.py` - Story aggregate root with StoryStatus enum
  4. `src/contexts/narrative/domain/entities/chapter.py` - Chapter entity with ChapterStatus enum
  5. `src/contexts/narrative/domain/value_objects/__init__.py` - Value objects package (placeholder)
  6. `tests/unit/contexts/narrative/domain/entities/test_story_entity.py` - 28 unit tests for Story
  7. `tests/unit/contexts/narrative/domain/entities/test_chapter_entity.py` - 21 unit tests for Chapter
- Attributes implemented:
  - Story: id, title, summary, status (DRAFT/PUBLISHED), created_at, updated_at, _chapters
  - Chapter: id, story_id, title, summary, order_index, status (DRAFT/PUBLISHED), created_at, updated_at
- Pattern discovered: Used dataclass with field(default_factory=...) for mutable defaults and timestamps
- Gotcha for future: Story.chapters returns a sorted copy (by order_index) to prevent external modification of internal list
- Verification: All 49 tests pass in 0.26s

## NAR-002 - 2026-01-31
- What I implemented: Scene & Beat domain entities for atomic narrative units
- Files created:
  1. `src/contexts/narrative/domain/entities/scene.py` - Scene entity with SceneStatus enum (DRAFT/GENERATING/REVIEW/PUBLISHED)
  2. `src/contexts/narrative/domain/entities/beat.py` - Beat entity with BeatType enum (ACTION/DIALOGUE/REACTION/REVELATION/TRANSITION/DESCRIPTION)
  3. `tests/unit/contexts/narrative/domain/entities/test_scene_entity.py` - 43 unit tests for Scene
  4. `tests/unit/contexts/narrative/domain/entities/test_beat_entity.py` - 41 unit tests for Beat
- Attributes implemented:
  - Scene: id, chapter_id, title, summary, order_index, status, location, created_at, updated_at, _beats
  - Beat: id, scene_id, content, order_index, beat_type, notes, created_at, updated_at
- Key methods:
  - Scene.reorder_beats(beat_ids): Atomic reordering for drag-and-drop UI
  - Scene.add_beat/remove_beat/get_beat: Beat management with scene_id validation
  - Beat.append_content: Streaming support for LLM generation
  - Beat.word_count/is_empty: Utility methods for writing progress tracking
- Pattern discovered: SceneStatus has GENERATING state for LLM generation workflow, while Beat allows empty content (placeholder beats)
- Gotcha for future: Scene.beats returns sorted copy by order_index; reorder_beats() validates beat_ids match exactly (no missing or extra)
- Verification: All 120 Narrative domain tests pass in 0.42s
