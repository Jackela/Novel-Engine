# Ralph Progress Log - Warzone 4: AI Brain
Started: 2025-02-05 (Reset)

Campaign: WARZONE 4 - Building the RAG (Retrieval-Augmented Generation) engine
Branch: feat/code-citadel

---

## Codebase Patterns

### Architecture
- **Hexagonal Architecture**: Routers -> Services -> Domain. No business logic in routers.
- **Result Pattern**: Use `Result[T, E]` for error handling in services (see `src/core/result.py`)
- **Domain Events**: Use events for cross-context communication, not direct imports
- **Import Linting**: Rules defined in `.importlinter` to enforce architectural boundaries
- **Vector Storage**: ChromaDB adapter in `src/contexts/knowledge/infrastructure/adapters/chromadb_vector_store.py`
- **Type Annotations**: Use `from __future__ import annotations` and import List/Tuple from typing for complex types
- **RAG Retrieval**: RetrievalService in `src/contexts/knowledge/application/services/retrieval_service.py` with filtering and deduplication
- **BM25 Keyword Search**: BM25Retriever in `src/contexts/knowledge/application/services/bm25_retriever.py` for exact keyword matching
- **Hybrid Retrieval**: HybridRetriever in `src/contexts/knowledge/application/services/hybrid_retriever.py` combines vector and BM25 with RRF
- **Query Rewriting**: QueryRewriter in `src/contexts/knowledge/application/services/query_rewriter.py` with SYNONYM/DECOMPOSE/CLARIFICATION strategies
- **Reranking**: IReranker port in `src/contexts/knowledge/application/ports/i_reranker.py` and RerankService with fallback behavior
- **Token Counting**: TokenCounter in `src/contexts/knowledge/application/services/token_counter.py` with multi-provider tiktoken support
- **Context Optimization**: ContextOptimizer in `src/contexts/knowledge/application/services/context_optimizer.py` with 4 packing strategies (relevance, diversity, remove_redundancy, compress_summaries)
- **Prompt Templates**: PromptTemplate entity in `src/contexts/knowledge/domain/models/prompt_template.py` with {{variable}} syntax and version tracking
- **Prompt Inheritance**: Use `extends` field and `{{> template}}` syntax for template composition. Variable override works by child having same-named variable.
- **Prompt Repository**: IPromptRepository port in `src/contexts/knowledge/application/ports/i_prompt_repository.py` with CRUD, version history, and search
- **Model Registry**: ModelRegistry in `src/contexts/knowledge/application/services/model_registry.py` with task-based routing and aliases
- **Entity Extraction**: EntityExtractionService in `src/contexts/knowledge/application/services/entity_extraction_service.py` with LLM-based extraction
- **Co-reference Resolution**: CoreferenceResolutionService in `src/contexts/knowledge/application/services/coreference_resolution_service.py` with heuristic + LLM fallback
- **Large Text Processing**: extract_large_text() with chunking (chunk_size, overlap) and merging for texts exceeding token limits
- **Token Tracking**: TokenTracker in `src/contexts/knowledge/application/services/token_tracker.py` with decorator/context manager support
- **Token Usage Entity**: TokenUsage in `src/contexts/knowledge/domain/models/token_usage.py` with cost calculation using model pricing
- **Token Usage Repository**: ITokenUsageRepository port in `src/contexts/knowledge/application/ports/i_token_usage_repository.py` with InMemoryTokenUsageRepository implementation
- **Budget Alerts**: BudgetAlertService in `src/contexts/knowledge/application/services/budget_alert_service.py` with threshold-based alerting
- **Alert Configuration**: BudgetAlertConfig in `src/contexts/knowledge/domain/models/budget_alert.py` with threshold types, operators, severity, frequency

### Frontend
- **Zustand Stores**: Feature-based organization (4 stores: authStore, orchestrationStore, decisionStore, weaverStore)
- **State Management Hierarchy**: TanStack Query -> Zustand -> React Hook Form -> useState
- **Schema SSOT**: Backend Pydantic schemas (`src/api/schemas.py`) drive frontend Zod schemas (`frontend/src/types/schemas.ts`)

### Testing
- **TDD/BDD**: Write failing test first, implement minimum code, verify with E2E
- **Test File Organization**: Keep files under 500 lines, split by functionality
- **Quality Gates**: `pytest tests/ && npm run test:e2e && mypy . && npm run type-check`

### Schema Synchronization
- Backend schemas are SSOT in `src/api/schemas.py`
- Frontend schemas live in `frontend/src/types/schemas.ts` (Zod)
- Regenerate OpenAPI with `python scripts/generate_openapi.py` after schema changes
- Zod's `z.number()` is correct for both Python `int` and `float`

---

## 2025-02-05 - BRAIN-035B-01
- **What was implemented:**
  - Added GET `/api/brain/models` endpoint returning model pricing data from ModelRegistry
  - Added `ModelPricingResponse` Pydantic model with provider, model name, display name, costs, and context info
  - Added frontend `getModelPricing()` API function
  - Created model comparison table in Usage tab of Brain Settings page
  - Table displays models grouped by provider (OpenAI, Anthropic, Gemini, Ollama)
  - Shows cost per 1M tokens (input/output) and context window size
- **Files changed:**
  - `src/api/routers/brain_settings.py` - Added model pricing endpoint
  - `frontend/src/features/routing/api/brainSettingsApi.ts` - Added API function
  - `frontend/src/features/routing/components/BrainSettingsPage.tsx` - Added comparison table UI
- **Learnings for future iterations:**
  - ModelRegistry DEFAULT_MODELS dict contains all model definitions with pricing
  - Use `provider` value for API responses, format for display in UI
  - Brain Settings Usage tab is the right place for pricing comparison
  - Table component from shadcn/ui provides consistent styling

---

## 2025-02-05 - BRAIN-035B-02
- **What was implemented:**
  - Added preset/custom mode toggle for date range filtering in Usage tab
  - Preset mode: 7, 30, 90 day quick-select buttons (existing functionality enhanced)
  - Custom mode: Native HTML date inputs for start/end date selection
  - Apply button calculates days from custom date range
  - Filter applies to all Usage tab charts (Tokens Over Time, Cost by Model, Provider Distribution)
  - Defaults to 30 days in preset mode
- **Files changed:**
  - `frontend/src/features/routing/components/BrainSettingsPage.tsx` - Added date range picker UI
- **Learnings for future iterations:**
  - Use `effectiveDays` pattern to calculate days from both preset and custom date ranges
  - Native HTML date inputs work well and don't require additional dependencies
  - Mode toggle (preset vs custom) provides good UX flexibility

---

## 2025-02-05 - BRAIN-035B-03
- **What was implemented:**
  - Added GET `/api/brain/usage/export` endpoint returning CSV file with usage data
  - CSV columns: Timestamp, Provider, Model, Input/Output/Total Tokens, Costs, Latency, Success
  - Added `exportUsageCsv()` frontend API function with file download handling
  - Added Export CSV button with Download icon to Usage tab header
  - Export respects current date range filter (uses `effectiveDays`)
- **Files changed:**
  - `src/api/routers/brain_settings.py` - Added CSV export endpoint
  - `frontend/src/features/routing/api/brainSettingsApi.ts` - Added export function
  - `frontend/src/features/routing/components/BrainSettingsPage.tsx` - Added export button
- **Learnings for future iterations:**
  - Use FastAPI Response with media_type "text/csv" for CSV downloads
  - Set Content-Disposition header with filename for proper browser download behavior
  - Frontend: Use blob download pattern with createObjectURL for file downloads

---
