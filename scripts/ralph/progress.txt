# Ralph Progress Log
Started: Fri Feb  6 19:52:52 CST 2026
---

## [2026-02-06] - OPT-012
- Implemented local model prompt strategy for DeepSeek, Llama, and other local models
- Files changed:
  - src/contexts/knowledge/domain/models/model_registry.py - Added PromptModelFamily and PromptFormat enums
  - src/contexts/knowledge/application/services/model_registry.py - Added DeepSeek, Llama 3.x, Codestral, Phi, Qwen models
  - src/contexts/knowledge/application/services/prompt_formatter.py - NEW: Prompt formatting service
  - tests/unit/contexts/knowledge/application/services/test_prompt_formatter.py - NEW: 38 tests for prompt formatting
  - src/contexts/knowledge/application/services/__init__.py - Exported new types and service
- Prompt formats implemented:
  - CHAT_MESSAGES: Role-based messages (OpenAI, Claude, Gemini)
  - INSTRUCTION: Alpaca-style instruction format (Llama, Mistral, Phi, Qwen)
  - CODE_INSTRUCTION: DeepSeek-Coder specific format
  - COMPLETION: Simple completion format
- Auto-detection: ModelDefinition auto-detects family from model name and sets appropriate prompt format
- Model aliases added: deepseek, coder, llama, phi, qwen, codestral, and more

**Learnings for future iterations:**
- The token_counter module already has a ModelFamily enum for tokenizer selection - renamed my enum to PromptModelFamily to avoid conflicts
- Global find-replace operations can cause double-prefix issues (ModelFamily -> PromptModelFamily -> PromptPromptModelFamily) - need to be careful with consecutive replacements
- Domain models directory is in .gitignore - need to use `git add -f` to commit files from there
- The existing prompt template system (PromptTemplate with {{variable}} syntax) is separate from prompt formatting - the new PromptFormatter handles the outer structure (instruction vs chat format) while PromptTemplate handles variable substitution
- Model auto-detection in __post_init__ with frozen dataclass requires using object.__setattr__(self, "field", value)

---

## [2026-02-06] - OPT-013
- Created RAG Pipeline Architecture Diagram for onboarding and reviews
- Files changed:
  - docs/architecture/rag_pipeline.mermaid - NEW: Complete RAG pipeline visualization
  - docs/index.md - Added link to RAG diagram in Architecture section
  - README.md - Added link to RAG diagram with Chinese description
  - README.en.md - Added link to RAG diagram with English description
- Diagram covers the complete pipeline:
  - Ingestion Phase: Raw Text -> KnowledgeIngestionService -> TextChunker -> Chunked Document
  - Embedding Phase: EmbeddingCacheService -> EmbeddingServiceAdapter -> Embedded Chunks
  - Storage Phase: ChromaDBVectorStore -> Vector Store
  - Retrieval Phase: RetrievalService + HybridRetriever + BM25Retriever -> Candidate Results
  - Reranking Phase: RerankService -> Reranked Results (with fallback)
  - Generation Phase: format_context -> Formatted Context -> LLM Generation
- Component details included as HTML comments for onboarding reference

**Learnings for future iterations:**
- Mermaid subgraph syntax requires `direction TB` (top-bottom) or `direction LR` for proper layout
- Use different node shapes: `[Rectangle]` for services, `[("Rounded")]` for data stores/states
- Styling uses `classDef` and `class` keywords for color coding different phases
- The existing docs/architecture/ directory already has narrative_engine.mermaid and world_engine.mermaid as examples
- README.md is Chinese, README.en.md is English - both need to be updated for documentation changes
- docs/index.md uses the format "### [Architecture](./architecture/) ‚≠ê" - add new items under existing sections

---

## [2026-02-06] - OPT-014
- API Key Storage Hardening - Security improvements for brain settings
- Files changed:
  - src/api/routers/brain_settings.py - Removed random fallback key, added encryption requirement
  - tests/unit/api/routers/test_brain_settings_security.py - NEW: 25 security tests
  - config/env/.env.example - Added BRAIN_SETTINGS_ENCRYPTION_KEY documentation
  - SECURITY.md - Added API key storage security guidelines
  - README.md - Added encryption setup instructions
- Security improvements:
  - Removed random `_DEFAULT_ENCRYPTION_KEY = Fernet.generate_key()` fallback
  - get_fernet() now returns None when key not set (was: random key)
  - get_encryption_key() raises ValueError if key not set
  - _encrypt_api_key() and _decrypt_api_key() handle None fernet gracefully
  - _require_encryption() helper for API endpoints returns 503 when encryption unavailable
  - set_api_key() only stores if encryption succeeds (non-empty result)
- Unit tests cover:
  - Encrypted storage (keys stored encrypted, retrieved decrypted)
  - Masked output (first 8 + last 4 chars, dots in middle)
  - Log safety (no raw keys in logs, encrypted values don't contain original)
  - Encryption key requirement (503 error when key not set)
  - Graceful failure (operations return empty string, don't crash)

**Learnings for future iterations:**
- Fernet.generate_key() on every restart makes stored keys unreadable - was a latent bug
- Type annotations needed updating from `Fernet` to `Fernet | None` in many places
- The router endpoints using `Depends(get_fernet)` needed to handle None
- test_brain_settings_security.py needed `@pytest.mark.asyncio` for async repository methods
- config/env/ directory is in .gitignore - needed `git add -f` for .env.example
- Warning logs should use _ENCRYPTION_KEY_WARNING_SHOWN flag to avoid spamming

---
