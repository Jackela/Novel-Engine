# Ralph Progress - Visual Rescue (Full Refactor)

## Codebase Patterns
(Inherited from Character Evolution + new patterns)

### Component Organization
- Feature components: `frontend/src/features/{featureName}/components/`
- API clients: `frontend/src/lib/api/{feature}Api.ts`
- Composed components: `frontend/src/components/composed/` (AppShell, EditorLayout)
- shadcn/ui components: `frontend/src/components/ui/` (DO NOT MODIFY)

### Three Rendering Domains
- **App Shell**: Tailwind + shadcn/ui, font-sans, bg-background
- **Editor Canvas**: Custom CSS (.prose-editor), font-serif in literary mode, bg-paper
- **Graph Canvas**: Weaver colors, .weaver-node + status classes

### Orthogonal Theming
- Color mode: `class="dark"` on `<html>` (light/dark)
- Typography mode: `data-typography="literary"` on `<html>` (default/literary)
- 4 combinations must all work correctly

### State Management
- Server state → TanStack Query (useQuery, useMutation)
- Global UI state → Zustand stores
- Form state → React Hook Form + Zod validation
- Avoid duplicate truth in local + global stores

### Testing
- E2E tests: `frontend/tests/e2e/`
- Visual regression: Must capture all 4 theme combinations
- Run `npm run type-check && npm run lint:all` before commit

### API Patterns
- Zod schemas in `frontend/src/types/schemas.ts` must match backend
- Use frozen dataclasses for immutable value objects
- Character aggregate uses Optional fields for mutable state

### Previous Sprint Patterns (Character Evolution)
- recharts is installed - use Radar/RadarChart for personality visualization
- CharacterDetailsDialog uses Tabs with TabsList/TabsTrigger/TabsContent
- Character memories/goals stored in structured_data via workspace_character_store
- LLMWorldGenerator is the main AI generation service in `src/contexts/world/infrastructure/generators/`
- TanStack Router uses `$paramName` for dynamic route segments
- EditorComponent uses @tiptap/extension-mention for @mention autocomplete
- QuickCreateCharacterDialog provides minimal character creation flow
- Export functionality uses exportApi.ts with downloadAsJson utility

---

## 2026-02-02 - VIS-001
- **What was implemented**: Design tokens and font system setup
- **Files changed**:
  - `frontend/index.html` - Added Lora font to Google Fonts import (400/500/600 + italic)
  - `frontend/tailwind.config.js` - Added fontFamily.serif (Lora), fontFamily.display (Space Grotesk), fontFamily.mono (IBM Plex Mono), and paper/ink/accent-literary color utilities
  - `frontend/src/styles/tailwind.css` - Added --paper, --ink, --accent-literary CSS variables for light/dark modes, and [data-typography="literary"] selector rules
  - `CONVENTIONS.md` - Added project coding conventions document
  - `DESIGN_SYSTEM.md` - Added design system documentation
- **Learnings for future iterations:**
  - Font families in tailwind.config.js should use Manrope (not Inter) as primary sans font per DESIGN_SYSTEM.md
  - Literary theme CSS variables use HSL format without hsl() wrapper: e.g., `--paper: 40 30% 96%`
  - The [data-typography="literary"] selector must target .prose-editor class specifically (Editor Canvas domain only)
  - Dark mode literary theme uses warmer tones: `--paper: 30 15% 12%` (brownish dark) vs default dark `--background: 240 10% 3.9%` (bluish dark)
---

## 2026-02-02 - VIS-002
- **What was implemented**: Refactored component directory structure
- **Files changed**:
  - Created `frontend/src/components/composed/` directory with `AppShell.tsx` and `index.ts`
  - Deleted `frontend/src/shared/components/layout/AppLayout.tsx`
  - Updated `frontend/src/shared/components/layout/index.ts` - removed AppLayout export
  - Updated `frontend/src/app/ProtectedLayout.tsx` - import from `@/components/composed` instead of `@/shared/components/layout`
  - Deleted `frontend/src/components/graph/nodes/CharacterNode.tsx` (duplicate)
  - Deleted `frontend/src/components/graph/nodes/index.ts`
  - Updated `frontend/src/components/graph/RelationshipGraph.tsx` - inlined SimpleCharacterNode component
  - Updated `frontend/src/components/graph/index.ts` - removed CharacterNode export
- **Learnings for future iterations:**
  - Composed components go in `@/components/composed/` directory (AppShell, EditorLayout, etc.)
  - When CharacterNode is needed for Weaver/Graph Canvas, import from `@/features/weaver/components/nodes`
  - RelationshipGraph has its own SimpleCharacterNode inlined (simpler data model: name, archetype, avatarUrl)
  - The Weaver CharacterNode is more feature-rich (has role, traits, status, bio, etc.)
  - Named exports are preferred (`export function AppShell`) but default export is also provided for compatibility
---
