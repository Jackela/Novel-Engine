# Ralph Progress Log - Operation: Code Citadel
Started: 2026-02-03
Campaign: Technical Debt Repayment & Code Quality Improvement
---

## Codebase Patterns (Discovered from Director Mode)
- Beat entity already exists at src/contexts/narrative/domain/entities/beat.py with comprehensive BeatType enum
- Scene entity already contains _beats list with add_beat(), remove_beat(), reorder_beats() methods
- Domain entities use @dataclass pattern with __post_init__ for validation
- Entities have _touch() method to update updated_at timestamp on modifications
- Test files follow pattern: tests/unit/contexts/{context}/domain/entities/test_{entity}_entity.py
- Frontend API hooks use TanStack Query with dedicated query key factories
- Feature-specific components go in frontend/src/features/{feature}/components/
- Feature-specific API hooks go in frontend/src/features/{feature}/api/
- dnd-kit is used for drag-and-drop: useSortable for items, SortableContext + verticalListSortingStrategy for lists
- Dialog component exists in shadcn/ui; AlertDialog does NOT exist (use Dialog instead)
- Application services go in src/contexts/{context}/application/services/
- Service dataclasses use frozen=True for immutable output types (metrics, reports, issues)
- Recharts v3.7.0 is used for charts - use AreaChart with dual gradients for tension/energy curves
- Pacing API endpoint is at /structure/stories/{story_id}/chapters/{chapter_id}/pacing
- LLM prompts go in src/contexts/world/infrastructure/prompts/ as YAML files with system_prompt key
- LLMWorldGenerator follows pattern: _load_X_prompt(), _build_X_user_prompt(), _parse_X_response() for each feature
- Use field(default_factory=list) for mutable defaults in dataclasses
- api is a named export from '@/lib/api', not a default export
- For dnd-kit DragStartEvent, use event.active.id (not event.activeId) to get the dragged item ID

## Known Issues to Address
- Schema drift: Backend Pydantic schemas (2080 lines) and frontend Zod schemas (1594 lines) need alignment
- Duplicate types: CombatStats, StructuredCharacterData, EquipmentItem duplicated in dtoTransforms.ts
- Context coupling: Character context imports orchestration
- Error handling: Inconsistent Result pattern usage
- Technical debt: 13 TODOs/FIXMEs (11 backend, 2 frontend)
- Test bloat: Largest test file 2144 lines
- Documentation gaps: Missing ADRs for recent decisions
- State fragmentation: 5+ Zustand stores need consolidation

---
