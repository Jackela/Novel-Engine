# Story 1.1: Narrative Engine Foundation

## Status
Completed

## Story
**As a** Simulation System Administrator,
**I want** the DirectorAgent to load and parse Campaign Brief documents to provide rich narrative context,
**so that** the simulation can evolve from simple battle mechanics to story-driven character interactions with meaningful non-combat scenarios.

## Acceptance Criteria

1. **DirectorAgent Upgrade**: `DirectorAgent` must be refactored to load and parse a specified "Campaign Brief" document (YAML or Markdown format) that defines:
   - Campaign setting and atmosphere
   - Key narrative events and triggers
   - Character ecological context and relationships
   - Environmental story elements

2. **Narrative Context Injection**: In each turn, `DirectorAgent` must send unique, narrative-rich "situation updates" to each `PersonaAgent` based on:
   - Current campaign brief context
   - Character-specific story elements
   - Environmental narrative details
   - Dynamic story progression markers

3. **PersonaAgent Evolution**: `PersonaAgent.decision_loop()` must be enhanced to:
   - Process narrative situation updates (beyond basic threat assessments)
   - Generate non-combat actions: "investigate", "dialogue", "betrayal", "diplomacy"
   - Respond to story-driven prompts with character-appropriate narrative decisions
   - Maintain story continuity across turns

4. **Sacred Validation**: Create comprehensive test suite for non-combat narrative scenario:
   - Test scenario: "Shadows of Serenity Station" (investigation-based)
   - Validate meaningful character interactions without combat
   - Verify narrative coherence and story progression
   - Confirm character agency in story-driven decisions

## Tasks / Subtasks

- [x] **Task 1: Campaign Brief Infrastructure** (AC: 1)
  - [x] Create `CampaignBrief` data model class with YAML/Markdown parsing
  - [x] Define campaign brief schema (setting, events, ecology, atmosphere)
  - [x] Implement campaign brief validation and error handling
  - [x] Add campaign brief loading to DirectorAgent initialization
  - [x] Create sample campaign brief: "Shadows of Serenity Station"

- [x] **Task 2: DirectorAgent Narrative Enhancement** (AC: 1, 2)
  - [x] Refactor `DirectorAgent.run_turn()` to include narrative context generation
  - [x] Implement `generate_narrative_context()` method for situation updates
  - [x] Create character-specific narrative injection logic
  - [x] Enhance world state updates with story elements
  - [x] Add narrative progression tracking

- [x] **Task 3: PersonaAgent Story Intelligence** (AC: 3)
  - [x] Extend `decision_loop()` to process narrative situation updates
  - [x] Implement non-combat action generation ("investigate", "dialogue", "betrayal")
  - [x] Enhance LLM prompt construction with narrative context
  - [x] Add story continuity awareness to character decisions
  - [x] Update fallback decision system for narrative actions

- [x] **Task 4: Narrative Action Framework** (AC: 3)
  - [x] Create new action types: Investigation, Dialogue, Diplomacy, Betrayal
  - [x] Implement action resolution logic for non-combat scenarios
  - [x] Add narrative outcome generation for story actions
  - [x] Integrate narrative actions with campaign log

- [x] **Task 5: Sacred Validation Suite** (AC: 4)
  - [x] Create "Shadows of Serenity Station" test campaign brief
  - [x] Implement narrative scenario test suite
  - [x] Add tests for non-combat character interactions
  - [x] Validate story progression and coherence
  - [x] Create assertion framework for narrative quality

## Dev Notes

### Previous Story Insights
This is the first story in the epic, establishing the foundation for narrative-driven simulation.

### Data Models
**Campaign Brief Structure** [Source: Epic Requirements]:
```python
@dataclass
class CampaignBrief:
    title: str
    setting: str
    atmosphere: str
    key_events: List[NarrativeEvent]
    character_ecology: Dict[str, Any]
    environmental_elements: List[str]
    story_progression_markers: List[str]
```

**Narrative Event Structure**:
```python
@dataclass
class NarrativeEvent:
    trigger_condition: str
    description: str
    character_impact: Dict[str, str]
    environmental_change: str
```

### API Specifications
**DirectorAgent Enhancement** [Source: Architecture_Blueprint.md#DirectorAgent]:
- Extend `__init__()` to accept `campaign_brief_path` parameter
- Add `load_campaign_brief()` method for YAML/Markdown parsing
- Enhance `run_turn()` with narrative context generation
- Implement `generate_narrative_context(agent_id: str)` method

**PersonaAgent Enhancement** [Source: Architecture_Blueprint.md#PersonaAgent]:
- Extend `decision_loop()` to process narrative updates
- Add narrative action types to action evaluation
- Enhance `_construct_character_prompt()` with story context
- Update `_identify_available_actions()` for non-combat scenarios

### Component Specifications
**New Action Types**:
- `InvestigateAction`: Gather information about story elements
- `DialogueAction`: Engage in conversation with NPCs/other agents  
- `DiplomacyAction`: Attempt negotiation or alliance building
- `BetrayalAction`: Act against established relationships

### File Locations
Based on current project structure:
- `director_agent.py`: Enhance existing DirectorAgent class
- `agents/persona_agent/agent.py`: Enhance existing PersonaAgent class  
- `campaign_brief.py`: New file for campaign brief data models
- `narrative_actions.py`: New file for story-driven action types
- `codex/campaigns/shadows_serenity_station/`: Campaign brief and assets
- `test_narrative_engine.py`: New comprehensive test suite

### Testing Requirements
**Test Framework**: Follow existing pattern using pytest and comprehensive logging
**Test Coverage**:
- Campaign brief loading and validation
- Narrative context generation
- Non-combat action processing
- Story progression validation
**Test Scenario**: "Shadows of Serenity Station" - Investigation mystery on abandoned Imperial station

### Technical Constraints
- **LLM Integration**: Utilize existing Gemini API integration pattern [Source: agents/persona_agent/agent.py#_call_llm]
- **Configuration**: Leverage existing ConfigLoader system [Source: src/core/config/config_loader.py]
- **Error Handling**: Follow established error resilience patterns [Source: Architecture_Blueprint.md#Production Features]
- **Performance**: Maintain existing caching and optimization protocols

### Project Structure Notes
All file paths align with current project structure. New narrative components will extend existing architecture without breaking changes.

## Testing

### Testing Standards [Source: Architecture_Blueprint.md#Testing Strategy]
- **Test Location**: `test_narrative_engine.py` in project root
- **Testing Framework**: pytest with comprehensive logging
- **Test Patterns**: Follow existing integration test patterns from `test_integration.py`
- **Coverage Requirements**: Minimum 85% coverage for new narrative components

### Specific Testing Requirements
- Campaign brief parsing validation (valid/invalid YAML)
- Narrative context generation for different character types
- Non-combat action execution and resolution
- Story progression tracking across multiple turns
- Character interaction quality in narrative scenarios

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-01 | 1.0 | Initial story creation for Narrative Engine Foundation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) - Full Stack Developer Agent

### Debug Log References  
- Fixed circular import issue between agents/persona_agent/agent.py and narrative_actions.py by creating core/types/shared_types.py
- Resolved test failures in narrative engine test suite through proper mocking and structure validation
- All existing tests continue to pass, ensuring backward compatibility

### Completion Notes List
- Successfully implemented complete narrative engine transformation from combat simulator to story-driven simulation
- Campaign brief infrastructure supports YAML and Markdown parsing with comprehensive validation
- DirectorAgent enhanced with narrative context generation and story state tracking
- PersonaAgent evolved to support narrative decision-making with story intelligence
- Narrative action framework provides investigate, dialogue, diplomacy, and betrayal actions with meaningful outcomes
- Comprehensive test suite validates non-combat scenarios using "Shadows of Serenity Station" campaign

### File List
**New Files Created:**
- `campaign_brief.py` - Campaign brief data models and YAML/Markdown parsing
- `narrative_actions.py` - Narrative action types and resolution framework  
- `core/types/shared_types.py` - Shared data structures to resolve circular imports
- `test_narrative_engine.py` - Comprehensive test suite for narrative engine
- `codex/campaigns/shadows_serenity_station/campaign_brief.yaml` - Sample campaign brief

**Files Enhanced:**
- `director_agent.py` - Added campaign brief loading, narrative context generation, story state tracking, narrative action processing
- `agents/persona_agent/agent.py` - Added narrative situation processing, story-driven action identification, enhanced LLM prompts with narrative context

## QA Results
*Results from QA Agent review will be populated here*

